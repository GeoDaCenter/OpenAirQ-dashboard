# EXTERNAL LIBRARIES
library(shiny)
library(shinydashboard)
library(shinyWidgets)
library(dashboardthemes)
library(leaflet)
library(rgdal)
library(sf)
library(lubridate)
library(grDevices)
library(tidyverse)
library(classInt)
library(plotly)
library(data.table)
library(raster)
library(scales)
library(zoo)
library(ggthemes)

# FUNCTIONS FOR APP USE
source("DashFunctions.R")

##### DATA LOADING START #####


#### HISTORIC RASTERS
master.raster <- stack("Data/Master_Raster.grd")
monthly.raster <- stack("Data/EPA_Monthly.grd")
faa.mon.raster <- stack("Data/FAA_Monthly.grd")

#### HISTORIC SENSOR READINGS
epa.quarterly <- st_read("Data/EPA_Quarterly.geojson")
faa.quarterly <- st_read("Data/FAA_Quarterly.geojson")

epa.monthly <- st_read("Data/EPA_Monthly.geojson")
faa.monthly <- st_read("Data/FAA_Monthly.geojson")

#### COUNTY LEVEL DATA
large.area <- st_read("Data/LargeAreaCounties")
large.area$COUNTYNAME <- as.character(large.area$COUNTYNAME)
county.avgs <- read.csv("Data/county_averages_monthly.csv")
county.avgs$Name <- as.character(county.avgs$Name)
var.avgs <- colMeans(county.avgs[,4:ncol(county.avgs)], na.rm = T)

#### MAP DATA
chi.map <- st_read("Data/Chicago")
chi.admin.map<- st_read("Data/ZipcodeBoundary")
chi.boundary<- st_union(chi.admin.map)

#### Variable Descriptions
descriptions <- read.csv("Data/Description.csv", stringsAsFactors = F)

#### HEALTH EXPLORER DATA
pm25<- read.csv("Data/PM25_Weekly/pm25.csv")
pm25.means<- read.csv("Data/PM25_Weekly/pm25_means.csv")
week.idx<- read.csv("Data/Week_Index.csv")$x
pm25.trace<- read.csv("Data/PM25_Weekly/pm25_trace.csv")$x
aqi<- read.csv("Data/PM25_Weekly/aqi.csv")
aqi.trace<- rev(read.csv("Data/PM25_Weekly/aqi_means.csv")[, -1])
covid.raw<- read.csv("Data/COVID/CovidWeekly.csv")
covid.means<- read.csv("Data/COVID/covid_means.csv", row.names=1)
covid.trace<- rev(covid.means[, -1])
asthma.raw<- read.csv("Data/COVID/Asthma2017.csv")

covid<- st_read("Data/COVID/covid.geojson")
asthma<- st_read("Data/COVID/asthma.geojson")

trees.all <- st_read("Data/Tract")
trees.var <- c("geoid", "svi_pecent", "trees_crow", "logtraf",
               "urban_floo", "heatisl","nn_q3_pm2_", "asthma_5yr",
               "hardship")
trees <- trees.all[,trees.var]

cdph.permits <- st_read("Data/CDPH_Permits")


#NN Data Loading
nn.raster <- stack("Data/NN/nn_21_base.grd")
nn.names <- read.csv("Data/NN_Raster_Names_New.csv")
names(nn.raster) <- nn.names$nn_names

##### DATA LOADING END #####

##### VARIABLE START #####

mapheight = "60vh"

start_date<- strptime(names(covid)[ncol(covid) - 1], "COVID_Week_%Y%m%d")
end_date<- strptime(names(covid)[6], "COVID_Week_%Y%m%d")
daterange<- paste("From", end_date, "to", end_date + days(6), sep = " ")

##### COLOR BREAKS #####

pm25.bins <- classIntervals(na.omit(unlist(pm25[,7:ncol(pm25)])), 5, style="fisher")$brks # 5 natural bins
pm25palette <- colorBin(palette="YlOrRd" , bins=pm25.bins, na.color="dimgrey") # discrete

aqi.bins<- c(0, 50, 100, 150, 200, 300, 500)
aqi.palette<- c('#00FF00','#FFFF00','#FFA500','#FF0000','#99004C','#800000')
aqi.legend.labels<- c("Good", "Moderate", "USG", 
                      "Unhealthy", "Very Unhealthy", "Harzardous")

aqipalette <- colorBin(palette= aqi.palette, bins = aqi.bins, na.color="dimgrey")

covid.bins <- classIntervals(na.omit(c(sapply(6:15, function(z) covid[,z][[1]]))), 5, style="fisher")$brks # 5 natural bins
covidpalette <- colorBin(palette="YlOrRd" , bins=covid.bins, na.color="transparent") # discrete

asthma.bins <- classIntervals(na.omit(c(sapply(6:7, function(z) asthma[,z][[1]]))), 5, style="fisher")$brks # 5 natural bins
asthmapalette <- colorBin(palette="YlOrRd" , bins=asthma.bins, na.color="transparent") # discrete

svi.bins <- classIntervals(na.omit(trees$svi_pecent), 5, style="fisher")$brks # 5 natural bins
svipalette <- colorBin(palette="YlOrRd" , bins=svi.bins, na.color="transparent") # discrete

hard.bins <- classIntervals(na.omit(trees$hardship), 5, style="fisher")$brks # 5 natural bins
hardpalette <- colorBin(palette="YlOrRd" , bins=hard.bins, na.color="transparent") # discrete

##### COLOR BREAKS END #####

##### TAB SETUP START #####

##### NN START #####
nn.description <- c("This neural net model was generated by the Center for Spatial Data Science at the University of Chicago. It is a multi-stage model incorporating readings from NASA's Aerosol Optical Depth dataset and approximately a dozen other air quality covariates. The model was run once per month for a period between March of 2014 and December of 2018. ")
nn.source <- c("This model was generated using publicly available air quality covariates by the Center for Spatial Data Science at the University of Chicago. ")

##### NN END #####

##### AOD START #####
aod.tabname <- "aod"
aod.name <- "Aerosol Optical Depth"

aod.description <- descriptions$Description[descriptions["Variable"] == "AOD"]
aod.source <- descriptions$Source[descriptions["Variable"] == "AOD"]

##### AOD END #####

##### NDVI START #####
ndvi.tabname <- "ndvi"
ndvi.name <- "Normalized Difference Vegetation Index"
ndvi.description <- descriptions$Description[descriptions["Variable"] == "NDVI"]
ndvi.source <- descriptions$Source[descriptions["Variable"] == "NDVI"]

##### NDVI END #####

##### BRF START #####

brf.tabname <- "brf"
brf.name <- "Bidirectional Reflectance Factor"
brf.description <- descriptions$Description[descriptions["Variable"] == "BRF"]
brf.source <- descriptions$Source[descriptions["Variable"] == "BRF"]

##### BRF END #####

##### LAND COVER START #####
lc.tabname <- "landcover"
lc.name <- "Land Cover"
lc.description <- descriptions$Description[descriptions["Variable"] == "Land Cover"]
lc.source <- descriptions$Source[descriptions["Variable"] == "Land Cover"]

##### ELEVATION START #####

elevation.tabname <- "elevation"
elevation.name <- "Elevation"
elevation.description <- descriptions$Description[descriptions["Variable"] == "Elevation"]
elevation.source <- descriptions$Source[descriptions["Variable"] == "Elevation"]


##### ELEVATION END #####

##### PM2.5 START #####

pm25.tabname <- "pm25"
pm25.name <- "Particulate Matter < 2.5μm (PM2.5)"
pm25.description <- descriptions$Description[descriptions["Variable"] == "PM2.5"]
pm25.source <- descriptions$Source[descriptions["Variable"] == "PM2.5"]

##### PM2.5 END #####

##### PM10 START #####

pm10.tabname <- "pm10"
pm10.name <- "Particulate Matter < 10μm (PM10)"
pm10.description <- descriptions$Description[descriptions["Variable"] == "PM10"]
pm10.source <- descriptions$Source[descriptions["Variable"] == "PM10"]


##### PM10 END #####

##### CO START #####
co.tabname <- "co"
co.name <- "Carbon Monoxide"
co.description <- descriptions$Description[descriptions["Variable"] == "CO"]
co.source <- descriptions$Source[descriptions["Variable"] == "CO"]
##### CO END #####

##### NO2 START #####

no2.tabname <- "no2"
no2.name <- "Nitrogen Dioxide"
no2.description <- descriptions$Description[descriptions["Variable"] == "NO2"]
no2.source <-  descriptions$Source[descriptions["Variable"] == "NO2"]

##### NO2 END #####

##### O3 START #####

o3.tabname <- "o3"
o3.name <- "Ozone"
o3.description <- descriptions$Description[descriptions["Variable"] == "Ozone"]
o3.source <- descriptions$Source[descriptions["Variable"] == "Ozone"]

##### O3 END #####

##### SO2 START #####

so2.tabname <- "so2"
so2.name <- "Sulfur Dioxide"
so2.description <- descriptions$Description[descriptions["Variable"] == "SO2"]
so2.source <- descriptions$Source[descriptions["Variable"] == "SO2"]

##### SO2 END #####

##### PB START #####

pb.tabname <- "pb"
pb.name <- "Lead"
pb.description <- descriptions$Description[descriptions["Variable"] == "Pb"]
pb.source <- descriptions$Source[descriptions["Variable"] == "Pb"]

##### PB END #####

##### PE START #####

pe.tabname <- "pe"
pe.name <- "Point Emissions"
pe.description <- descriptions$Description[descriptions["Variable"] == "Point Emissions"]
pe.source <- descriptions$Source[descriptions["Variable"] == "Point Emissions"]

##### PE END #####

##### ROADS START #####

roads.tabname <- "roads"
roads.name <- "Road Emissions"
roads.description <- descriptions$Description[descriptions["Variable"] == "Roads"]
roads.source <- descriptions$Source[descriptions["Variable"] == "Roads"]

##### ROADS END #####

##### TEMP START #####

temp.tabname <- "temp"
temp.name <- "Temperature"
temp.description <- descriptions$Description[descriptions["Variable"] == "Temperature"]
temp.source <- descriptions$Source[descriptions["Variable"] == "Temperature"]

##### TEMP END #####

##### PRESSURE START #####

pressure.tabname <- "pressure"
pressure.name <- "Barometric Pressure"
pressure.description <- descriptions$Description[descriptions["Variable"] == "Pressure"]
pressure.source <- descriptions$Source[descriptions["Variable"] == "Pressure"]

##### PRESSURE END #####

##### PRECIP START #####

precip.tabname <- "precip"
precip.name <- "Precipitation"
precip.description <- descriptions$Description[descriptions["Variable"] == "Precip"]
precip.source <- descriptions$Source[descriptions["Variable"] == "Precip"]

##### PRECIP END #####

##### TAB SETUP END #####

##### PLOT ADJUSTMENT START #####

master.raster$PECount[which(getValues(master.raster$PECount) == 0)] <- NA ### Needed for plotting; raster error when try to write new file
master.raster$RdDnsty[which(getValues(master.raster$RdDnsty) == 0)] <- NA

##### PLOT ADJUSTMENT END #####

##### COVID START #####

labels_covid <- sprintf(
  as.character(covid$zip)
) %>% lapply(htmltools::HTML)

# zoom boundaries for COVID maps
counties.bounds <- st_bbox(large.area$geometry)
names(counties.bounds) <- c("lng1", "lat1", "lng2", "lat2")
counties.bounds <- split(unname(counties.bounds), names(counties.bounds))

chi.bounds <- st_bbox(chi.admin.map$geometry)
names(chi.bounds) <- c("lng1", "lat1", "lng2", "lat2")
chi.bounds <- split(unname(chi.bounds), names(chi.bounds))

##### COVID END #####

##### VARIABLE END #####

##### THEME START #####

chicago_blue <- "rgb(128, 206, 255)"
chicago_red <- "rgb(199, 20, 20)"

sidebar_select_gradient <- cssGradientThreeColors(
  direction = "right"
  ,colorStart = "rgb(255, 67, 67)"
  ,colorMiddle = "rgb(255, 120, 120)"
  ,colorEnd = "rgb(255,175,175)"
  ,colorStartPos = 0
  ,colorMiddlePos = 30
  ,colorEndPos = 100
)

sidebar_hover_gradient <- sidebar_select_gradient

### creating custom theme object
theme_air_chicago <- shinyDashboardThemeDIY(

  ### general
  appFontFamily = "Arial"
  ,appFontColor = "rgb(0,0,0)"
  ,primaryFontColor = "rgb(0,0,0)"
  ,infoFontColor = "rgb(0,0,0)"
  ,successFontColor = "rgb(0,0,0)"
  ,warningFontColor = "rgb(0,0,0)"
  ,dangerFontColor = "rgb(0,0,0)"
  ,bodyBackColor = "rgb(217,217,217)"

  ### header
  ,logoBackColor = chicago_blue

  ,headerButtonBackColor = chicago_blue
  ,headerButtonIconColor = "rgb(245,245,245)"
  ,headerButtonBackColorHover = chicago_blue
  ,headerButtonIconColorHover = "rgb(0,0,0)"

  ,headerBackColor = chicago_blue
  ,headerBoxShadowColor = "#aaaaaa"
  ,headerBoxShadowSize = "2px 2px 2px"

  ### sidebar
  ,sidebarBackColor = chicago_blue
  ,sidebarPadding = 2
  
  ,sidebarMenuBackColor = "transparent"
  ,sidebarMenuPadding = 0
  ,sidebarMenuBorderRadius = 0

  ,sidebarShadowRadius = "3px 5px 5px"
  ,sidebarShadowColor = "#aaaaaa"

  ,sidebarUserTextColor = "rgb(255,255,255)"

  ,sidebarSearchBackColor = "rgb(55,72,80)"
  ,sidebarSearchIconColor = "rgb(153,153,153)"
  ,sidebarSearchBorderColor = "rgb(55,72,80)"

  ,sidebarTabTextColor = "rgb(255,255,255)"
  ,sidebarTabTextSize = 13
  ,sidebarTabBorderStyle = "none none solid none"
  ,sidebarTabBorderColor = "rgb(35,106,135)"
  ,sidebarTabBorderWidth = 1

  ,sidebarTabBackColorSelected = sidebar_select_gradient
  ,sidebarTabTextColorSelected = "rgb(0,0,0)"
  ,sidebarTabRadiusSelected = "0px 20px 20px 0px"

  ,sidebarTabBackColorHover = sidebar_hover_gradient
  ,sidebarTabTextColorHover = "rgb(50,50,50)"
  ,sidebarTabBorderStyleHover = "none none solid none"
  ,sidebarTabBorderColorHover = "rgb(75,126,151)"
  ,sidebarTabBorderWidthHover = 1
  ,sidebarTabRadiusHover = "0px 20px 20px 0px"

  ### boxes
  ,boxBackColor = "rgb(255,255,255)"
  ,boxBorderRadius = 5
  ,boxShadowSize = "0px 1px 1px"
  ,boxShadowColor = "rgba(0,0,0,.1)"
  ,boxTitleSize = 16
  ,boxDefaultColor = "rgb(210,214,220)"
  ,boxPrimaryColor = "rgba(44,222,235,1)"
  ,boxInfoColor = "rgb(210,214,220)"
  ,boxSuccessColor = "rgba(0,255,213,1)"
  ,boxWarningColor = "rgb(244,156,104)"
  ,boxDangerColor = "rgb(255,88,55)"

  ,tabBoxTabColor = "rgb(255,255,255)"
  ,tabBoxTabTextSize = 14
  ,tabBoxTabTextColor = "rgb(0,0,0)"
  ,tabBoxTabTextColorSelected = "rgb(0,0,0)"
  ,tabBoxBackColor = "rgb(255,255,255)"
  ,tabBoxHighlightColor = "rgba(44,222,235,1)"
  ,tabBoxBorderRadius = 5

  ### inputs
  ,buttonBackColor = "rgb(245,245,245)"
  ,buttonTextColor = "rgb(0,0,0)"
  ,buttonBorderColor = "rgb(200,200,200)"
  ,buttonBorderRadius = 5

  ,buttonBackColorHover = "rgb(235,235,235)"
  ,buttonTextColorHover = "rgb(100,100,100)"
  ,buttonBorderColorHover = "rgb(200,200,200)"

  ,textboxBackColor = "rgb(255,255,255)"
  ,textboxBorderColor = "rgb(200,200,200)"
  ,textboxBorderRadius = 5
  ,textboxBackColorSelect = "rgb(245,245,245)"
  ,textboxBorderColorSelect = "rgb(200,200,200)"

  ### tables
  ,tableBackColor = "rgb(255,255,255)"
  ,tableBorderColor = "rgb(240,240,240)"
  ,tableBorderTopSize = 1
  ,tableBorderRowSize = 1
)

##### THEME END #####

ui <- dashboardPage(
  title = "Open Air Chicago",

  ##### LOGO START #####
  dashboardHeader(title = shinyDashboardLogoDIY(boldText = "Open Air",
                                                    mainText = "Chicago",
                                                    textSize = 16,
                                                    badgeText = "BETA",
                                                    badgeTextColor = "white",
                                                    badgeTextSize = 2,
                                                    badgeBackColor = chicago_red,
                                                    badgeBorderRadius = 3)
                      ),
  ##### LOGO END #####

  dashboardSidebar(sidebarMenu(id = "sidebar",
    menuItem("Home", tabName = "home", icon = icon("home"),
             menuSubItem("Introduction", tabName = "home", icon = icon("info")),
             menuSubItem("Region Explorer", tabName = "region", icon = icon("map-marked-alt")),
             menuSubItem("Health Explorer", tabName = "covid", icon = icon("medkit")),
             menuSubItem("Tree Equity Tool", href = "https://rhabus.carto.com/builder/50d25399-d7c7-4cf1-9e17-0ef44c7d7315/embed_protected?", icon = icon("tree")),
             menuSubItem("About", tabName = "about", icon = icon("question"))),
    menuItem("EPA Sensor Data", icon = icon("envira"),
             menuSubItem("PM2.5", tabName = "pm25"),
             menuSubItem("PM10", tabName = "pm10"),
             menuSubItem("Carbon Monoxide", tabName = "co"),
             menuSubItem("Nitrogen Dioxide", tabName = "no2"),
             menuSubItem("Ozone", tabName = "o3"),
             menuSubItem("Sulfur Dioxide", tabName = "so2"),
             menuSubItem("Lead", tabName = "pb")),
    menuItem("Meteorological Data", icon = icon("thermometer-half"),
             menuSubItem("Temperature", tabName = "temp"),
             menuSubItem("Pressure", tabName = "pressure"),
             menuSubItem("Precipitation", tabName = "precip")),
    menuItem("Remote-Sensed Data", icon = icon("wifi"),
             menuSubItem("Aerosol Optical Depth", tabName = "aod"),
             menuSubItem("NDVI", tabName = "ndvi"),
             menuSubItem("BRF", tabName = "brf"),
             menuSubItem("Land Cover", tabName = "landcover"),
             menuSubItem("Elevation", tabName = "elevation")),
    menuItem("PM2.5 Model", tabName = "nn", icon = icon("code-branch")),
    menuItem("Pollution Drivers", icon = icon("industry"),
             menuSubItem("Point Emissions", tabName = "pe"),
             menuSubItem("Roads", tabName = "roads")),
    menuItem("Chicago Health Atlas", href = "https://chicagohealthatlas.org", icon = icon("heartbeat")),
    menuItem("Downloads", icon = icon("download"), tabName = "downloads"))
  ),

  dashboardBody(
    
    tags$style(type = "text/css", "html, body {width:100%;height:100%}",
               ".leaflet .legend-circles i{
      border-radius: 50%;
      }
    "),

    theme_air_chicago,

    tabItems(

    ##### HOME START #####
    tabItem(tabName = "home",
    
            fluidRow(
              box(width = 12,  
                img(src='header.png', width = '100%', align = "center", style="max-width:1024px;display:block;margin:0 auto;", alt="Chicago's Open Air Quality Environment Explorer"),                
                h1("Explore current and historical trends of air quality in the Chicagoland area", align="center")
              )),
            fluidRow(
              box(width = 6,
                h2("What can this app do?", align = "center", style = "color: #80ceff"),
                p("This R-shiny based web application provides a current snapshot and look back at air quality indicators to visualize how measured air quality has changed
                 across space and time. Primarily, the data presented in this application takes the form of 1 kilometer x 1 kilometer raster data, reflecting a grid of data overlaid
                 on top of the Greater Chicagoland area.")
              ),
              box(width = 6,
                h2("Getting Started", align = "center", style = "color: #c71414"),
                p("In the menu, there are several categories of sensor data, including EPA sensors, Meteorological data, remote-sensing (satellite) data, and modeled data. Explore these
                tabs to see how different metrics shed light on the air quality of the diverse areas around Chicagoland.")
              )
            ),
            fluidRow(
              box(width = 6,
                h2("More Information", align = "center", style = "color: #c71414"),
                p("For further information about the project objectives, overview, team, and data access, visit the About tab under Home.")
              ),
              box(width = 6,
                h2("Open Source and Open Science", align = "center",  style = "color: #80ceff"),
                p("This project emphasizes open source code and open science data practices. To explore the code and data, visit the links below:"),
                tags$a(href="https://github.com/GeoDaCenter/OpenAirQ-dashboard/tree/master/Data", "Data"),
                tags$br(),
                tags$a(href="https://github.com/GeoDaCenter/OpenAirQ-dashboard", "Code")
              )
            ),
            fluidRow(
              box(width = 12,
                h3("Open Air Chicago is a project of", align = "center", style = "color: #c71414"),
                tags$hr(),
                tags$a(href="https://herop.ssd.uchicago.edu/",
                  img(src='herop.png', width = '50%', style="display:block;max-width:200px;margin:0 auto 20px auto", alt="Healthy Regions and Policy Lab")
                ),  
                tags$a(href="https://spatial.uchicago.edu/",
                  img(src='CSDS_logo_4C_1.jpg', width = '50%', style="display:block;max-width:200px;margin:0 auto 20px auto", alt="Center for Spatial Data Science"),
                )
              )
            )
    ),
    ##### HOME END #####

    ##### REGION EXPLORER START ####
    
    tabItem(tabName = "region",
            
            
            fluidRow(
              box(width = 12,
                  h2("Region Explorer", align = "center"),
                  textOutput("region-explorer-h2")
              )),
    
            fluidRow(
              box(width = 4,
                  helpText("Select one or multiple counties for comparison of regional trends."),
                  leafletOutput("homemap", height = mapheight),
                  checkboxGroupInput("homecheck", label = "", c("Show Mean" = "mean",
                                                                "Rescale Data" = "rescale"),
                                     selected = c("mean"),
                                     width = '100%',
                                     inline = TRUE)),
              box(width = 8,
                  selectizeInput("homevar", "Select Variables for Comparison:",
                                 c("Aerosol Optical Depth" = "AOD",
                                   "Normalized Difference Vegetation Index" = "NDVI",
                                   "Bidirectional Reflectance Factor" = "BRF",
                                   "PM2.5" = "PM25",
                                   "PM10" = "PM10",
                                   "Carbon Monoxide" = "CO",
                                   "Nitrogen Dioxide" = "NO2",
                                   "Ozone" = "Ozone",
                                   "Sulfur Dioxide" = "SO2",
                                   "Lead" = "Lead",
                                   "Temperature" = "Temp",
                                   "Barometric Pressure" = "Pressure"),
                                 options = list(maxItems = 7)),
                  plotlyOutput("homeplot", height = 445),
                  actionButton("clearshapes", "Clear Selection")))
            ),

    ##### REGION EXPLORER END #####

    ##### ABOUT START #####
    tabItem(tabName = "about",
            fluidRow(
              box(width = 12,
                  h2("About", align = "center"),
                  textOutput("abouttext")
              )),
            fluidRow(
              box(width = 6,
                h1("Overview", align = "center", style = "color: #80ceff"),
                p("Open Air Chicago is an interactive dashboard providing 
                  information on air quality for the greater Chicagoland area 
                  including Milwaukee. It includes direct measures of air quality 
                  as well as variables known to affect or relate to these variables. 
                  Each of the variables has an individual page with a 
                  variable description, source information, and interactive visualization. 
                  Additionally, the \"Home\" tab offers the option to explore broader trends 
                  within the data for a single variable or among several variables both at 
                  the broader Chicagoland scale and the individual county level. All data 
                  used to generate the graphs and maps on the dashboard are available for 
                  access on the \"Downloads\" tab.")
                ),
              box(width = 6,
                h2("Objectives", align = "center", style = "color: #c71414"),
                p("The primary goal of this dashboard is to provide both researchers and the public at large with clean, free, and easily accessible data for all things air quality. While all data used in the dashboard is technically available for free online, the numerous formats, sources, and options provide for an unwelcoming landscape. By streamlining the process through which the data is accessed, the hope is to enable more people to spend more time actually analyzing the data and working to improve air quality. Additionally, Open Air Chicago hopes to do this by offering data visualization options to explore individual variable data as well as relationships between variables over time.")
            )),
            fluidRow(
              box(width = 6,
                h2("Data", align = "center", style = "color: #c71414"),
                p("All data used to create the dashboard is available online free of charge. Sources include the Environmental Protection Agency (EPA), National Aeronautics and Space Administration (NASA),  National Oceanic and Atmospheric Association (NOAA), United States Geological Survey (USGS), and OpenStreetMap. Specific sourcing information is available on individual dashboard pages. County-level aggregates for all variables are available for download at a monthly and quarterly temporal resolution as CSV files on the “Downloads” tab. Also available on the “Downloads” tab is a GeoTiff raster file containing all of the 1km resolution gridded data.")
              ),
              box(width = 6,
                  h2("Methodology", align = "center",  style = "color: #80ceff"),
                  p("In addition to differing in source and format, the raw data also exists at a variety of spatial and temporal resolutions. All data was aggregated to a standard, 1km resolution grid at both monthly and quarterly intervals. For the EPA sensor data, the gridded values were extracted from an Inverse Distance Weighted interpolation of sensor averages. Interpolated values for variables with fewer sensors will be less accurate than those with more sensors. Due to data availability, particularly with NASA’s remote-sensed Aerosol Optical Depth, individual variable pages provide visualizations of the quarterly aggregates to maximize coverage. For data not originally provided at a 1km resolution, unless otherwise noted on the “Source” tab on each variable page, the value assigned to each 1km cell is the mean of all measured values within it.")
            )),
            fluidRow(
              box(width = 6,
                h2("Contributors", align="center"),
                p("Below are the contributors to the Open Air Chicago project."),
                tags$ul(
                  tags$li(tags$a(href="https://github.com/Makosak", "Marynia Kolak")),
                  tags$li(tags$a("Andrew Morse", href = "https://github.com/andrewjmorse")),
                  tags$li(tags$a("James Keane", href = "https://github.com/yahmskeano")),
                  tags$li(tags$a("Qiwei Lin", href = "https://github.com/QWL55")),
                  tags$li(tags$a("Dylan Halpern", href = "https://github.com/nofurtherinformation/"))
                )
              )
            )
    ),
    ##### ABOUT END #####
    
    ##### COVID START #####
    tabItem(tabName = "covid",
            fluidRow(
              box(width = 12,
                  sliderInput(paste("covid", "dt", sep = "_"), "Select week:",
                              min = start_date, 
                              max = end_date,
                              value = end_date,
                              timeFormat = "%Y/%m/%d",
                              step = as.difftime(7, units = "days"),
                              animate = animationOptions(interval = 2000)))
            ),
            fluidRow(
              box(width = 6,
                         selectInput(paste("covid_map_left", "sensor", sep = "_"),
                                     "Select Variable for Sensors",
                                     c("Air Quality Index" = "aqi",
                                       "PM2.5" = "pm25",
                                       "None" = "none"),
                                     selected = "aqi"),
                         selectInput(paste("covid_map_left", "choropleth", sep = "_"), 
                                     "Select Variable for Regions",
                                     c("Asthma ED Visits (0-18)" = "asthma018",
                                       "Asthma ED Visits (65+)" = "asthma65",
                                       "COVID-19 Cases" = "covid",
                                       "PM2.5 (Historical 5-Year)" = "pm25",
                                       "Social Vulnerability Index" = "svi",
                                       "None" = "none"),
                                     selected = "asthma018"),
                            leafletOutput("covid_map_left", height = mapheight)),
              box(width = 6,
                  selectInput(paste("covid_map_right", "sensor", sep = "_"),
                              "Select Variable for Sensors",
                              c("Air Quality Index" = "aqi",
                                "PM2.5" = "pm25",
                                "None" = "none"),
                              selected = "aqi"),
                  selectInput(paste("covid_map_right", "choropleth", sep = "_"), 
                              "Select Variable for Regions",
                              c("Asthma ED Visits (0-18)" = "asthma018",
                                "Asthma ED Visits (65+)" = "asthma65",
                                "COVID-19 Cases" = "covid",
                                "PM2.5 (Historical 5-Year)" = "pm25",
                                "Social Vulnerability Index" = "svi",
                                "None" = "none"),
                              selected = "covid"),
                  leafletOutput("covid_map_right", height = mapheight)))),
          
      # fluidRow(box(width = 12,
      #              plotlyOutput("covid_plot", height = mapheight)))),
      
    
    
    ##### COVID END #####
    
    ##### NN START #####
    
    tabItem(tabName = "nn",
            fluidRow(
              box(width = 4,
                  tabsetPanel(
                    tabPanel(title = "Description",
                             h3("PM2.5 Model"),
                             p(nn.description)),
                    tabPanel(title = "Source",
                             h4("Data Source"),
                             p(nn.source))),
              fluidRow(
                column(width = 5,
                       radioGroupButtons(inputId = paste("nn", "chi_zoom", sep = "_"),
                                         "Set View", 
                                         c("21 Counties" = "lac", 
                                           "Chicago" = "chi"))),
                column(width = 7,
                       radioGroupButtons(paste("nn", "rad", sep = "_"), "Select Color Palette", 
                                         c("Overall" = "ovr", "Yearly" = "yr", "Monthly" = "mon"), 
                                         selected = "ovr")),
                column(width = 12,
                       sliderTextInput("nn_dt", "Select Month:",
                                choices = format(seq.Date(as.Date("2014/01/01"), as.Date("2018/12/01"), by="month"),
                                                 "%Y/%m"),
                                selected = "2016/07", grid = FALSE)))),
              box(width = 8,
                  leafletOutput(paste("nn", "map", sep = "_"),height = "90vh"))
            )),
    
    
    ##### NN END #####
    
    ##### HISTORICAL DATA TABS START #####

    generateQuarterlyTab(aod.tabname, aod.name, aod.description, aod.source),

    generateQuarterlyTab(ndvi.tabname, ndvi.name, ndvi.description, ndvi.source),

    generateQuarterlyTab(brf.tabname, brf.name, brf.description, brf.source),

    tabItem(tabName = "landcover",
            fluidRow(
              box(width = 4,
                  tabsetPanel(
                    tabPanel(title = "Description",
                             h3(lc.name),
                             p(lc.description)),
                    tabPanel(title = "Source",
                             h4("Data Source"),
                             p(lc.source))),
                  radioGroupButtons(inputId = "lc_chi_zoom",
                                    "Set View", 
                                    c("21 Counties" = "lac", 
                                      "Chicago" = "chi"))),
              box(width = 8,
                  leafletOutput("lc_map", height = "90vh"),
                  radioGroupButtons(inputId = "lc_choose",
                                    "Select Index",
                                    c("Green" = "grn_ndx",
                                      "Gray" = "gry_ndx",
                                      "Blue" = "blu_ndx"))
                  )
            )
    ),

    generateOneTimeTab(elevation.tabname, elevation.name, elevation.description, elevation.source),

    generateDynaTab(pm25.tabname, pm25.name, pm25.description, pm25.source, radselect = "mon"),

    generateDynaTab(pm10.tabname, pm10.name, pm10.description, pm10.source),

    generateDynaTab(co.tabname, co.name, co.description, co.source),

    generateDynaTab(no2.tabname, no2.name, no2.description, no2.source),

    generateDynaTab(o3.tabname, o3.name, o3.description, o3.source),

    generateDynaTab(so2.tabname, so2.name, so2.description, so2.source),

    generateDynaTab(pb.tabname, pb.name, pb.description, pb.source),

    generateOneTimeTab(pe.tabname, pe.name, pe.description, pe.source, 
                       mapviewselected = "chi"),

    generateOneTimeTab(roads.tabname, roads.name, roads.description, roads.source),

    generateDynaTab(temp.tabname, temp.name, temp.description, temp.source),
    
    generateDynaTab(pressure.tabname, pressure.name, pressure.description, pressure.source),
    
    generateDynaTab(precip.tabname, precip.name, precip.description, precip.source),
    
    ##### VULNERABILITY START #####
    
    # generateOneTimeTab("svi", "Social Vulnerability Index", "", ""),
    # 
    # generateOneTimeTab("hardind", "Economic Hardship Index", "", ""),
    
    ##### VULNERABILITY END #####
    
    ##### DOWNLOADS START #####
    
    tabItem(tabName = "downloads",
            fluidRow(
              box(width = 12,
                  h1("Downloads", align = "center")
            )),
            
            fluidRow(
              box(width = 4,
                  h3("CSV", align = "center"),
                  downloadBttn("monthly_data",
                               label = "Download Monthly County Data",
                               style = "simple"),
                  downloadBttn("quarterly_data",
                               label = "Download Quarterly County Data",
                               style = "simple")),
              box(width = 4,
                  h3("Raster", align = "center"),
                  p("Warning: requires processing time", align = "center"),
                  downloadBttn("master_raster",
                               label = "Download 1km Quarterly Raster",
                               style = "simple"),
                  downloadBttn("monthly_raster",
                               label = "Download 1km Monthly Raster", 
                               style = "simple")),
              box(width = 4,
                  h3("Shapefile", align = "center"),
                  downloadBttn("large_area_counties",
                               label = "Download County Shapefile",
                               style = "simple"))
            ))
    
    
    ##### DOWNLOADS END #####

)))

server <- function(input, output) {


  ##### HOME START #####
  
  abt.count <- reactiveValues(val = 0) #Create counter to track hold of last shape clicked
  all.fips <- reactiveValues(fips = c())
  
  output$homemap <- renderLeaflet({
    leaflet(large.area) %>%
      addProviderTiles(provider = "OpenStreetMap.HOT") %>%
      setView(lat = "41.97736", lng = "-87.62255", zoom = 7) %>% 
      leaflet::addPolygons(weight = 1,
                           color = "gray",
                           layerId = large.area$FIPS,
                           fillOpacity = 0.2,
                           label = large.area$COUNTYNAME,
                           highlight = highlightOptions(
                             weight = 2,
                             color = "#666",
                             fillOpacity = 0.7,
                             bringToFront = TRUE))
  })
  
  observeEvent(input$clearshapes,{
    if(input$sidebar == "home") {
      home.proxy <- leafletProxy("homemap")
        if(input$clearshapes){
          home.proxy %>%
            removeShape(layerId = c(paste("Highlighted", all.fips$fips))) %>%
            setView(lat = 41.97736,
                    lng = -87.62255,
                    zoom = 7)
          all.fips$fips <- c()
      }
    }
  })
  
  
  # Highlight clicked counties, unhighlight double clicked, zoom to center of all selected
  observeEvent(input$homemap_shape_click, {
    if(input$sidebar == "home") { #Optimize Dashboard speed by not observing outside of tab
      
      this.fips <- input$homemap_shape_click$id
      
      home.proxy <- leafletProxy("homemap")
      
      if(nchar(this.fips) <= 5) { #Make sure that selected layer not highlighted
        abt.count$val <- abt.count$val + 1
        all.fips$fips[abt.count$val] <- this.fips
        
        for(i in 1:length(all.fips$fips)) { #Highlight selected counties
          home.proxy <- home.proxy %>%
            addPolygons(data = large.area[which(large.area$FIPS %in% all.fips$fips[i]),][1],
                        color = "red", layerId = paste("Highlighted", all.fips$fips[i]),
                        label = paste(large.area$COUNTYNAME[which(large.area$FIPS %in% all.fips$fips[i])], " County"))
        }
        
      } else {
        high.fips <- substring(this.fips, first = 13) #Extract FIPS from Layer Id
        home.proxy <- home.proxy %>%
          removeShape(layerId = c(paste("Highlighted", all.fips$fips)))  #Clear highlighted shapes from proxy
        
        all.fips$fips <- all.fips$fips[-which(all.fips$fips %in% high.fips)] #Remove fips from list of selected fips
        
        abt.count$val <- abt.count$val - 1 #Adjust for removed value
        
        for(i in 1:length(all.fips$fips)) { #Highlight all remaining counties 
          home.proxy <- home.proxy %>%
            addPolygons(data = large.area[which(large.area$FIPS %in% all.fips$fips[i]),][1],
                        color = "red", layerId = paste("Highlighted", all.fips$fips[i]),
                        label = paste(large.area$COUNTYNAME[which(large.area$FIPS %in% all.fips$fips[i])], " County"))
        }
      }
      
      view.lat <- mean(large.area$LAT[which(large.area$FIPS %in% all.fips$fips)])
      view.lon <- mean(large.area$LON[which(large.area$FIPS %in% all.fips$fips)])
      
      if(length(all.fips$fips) == 0) {
        view.lat <- 41.97736
        view.lon <- -87.62255
      }
      
      home.proxy %>%
        setView(lng = view.lon,
                lat = view.lat, 
                zoom = 7)
      
    }
  })
  
  output$homeplot <- renderPlotly({
    
    ##### Transform averages into plotly friendly format
    vars <- input$homevar
 
    if(is.null(vars)){
      p <- plot_ly() %>% config(displayModeBar = F) %>%
        layout(legend = list(x = .5, y = 100, orientation = "h"))
      p
      return()
    }

    these.vars.avgs <- list()
    
    for(i in 1:length(vars)) {
      these.vars.avgs[[i]] <- var.avgs[which(grepl(vars[i], names(var.avgs)))]
      
      if ("rescale" %in% input$homecheck) {
        these.vars.avgs[[i]] <- rescale(these.vars.avgs[[i]])
      }
    }
    
    
    months <- 1:12
    years <- 2014:2018
    dates <- c()
    
    for(i in 1:length(years)) {
      this.yr <- paste(months, "01", years[i], sep = "-")
      dates <- c(dates, this.yr)
      
    }
    dates <- mdy(as.character(dates))
    
    highlighted <- all.fips$fips
    
    if(length(all.fips$fips == 0)) {
      selected.fips <- 0
    }
    
    selected.fips <- which(county.avgs$FIPS %in% all.fips$fips)

    blues <- c("#033682", "#0356a3", "#0083d9", "#66ccff", "#c9e8ff")
    reds <- c("#9c1500", "#f52302", "#ff6e57", "#ff9a8a", "#ffc8bf")
    greens <- c("#165422", "#0b9926", "#14ff41", "#91faa5", "#d6ffde")
    yellows <- c("#8f8a00", "#d4cc04", "#faf005", "#f5f190", "#faf8c3")
    grays <- c("#343d46", "#4f5b66", "#65737e", "#a7adba", "#c0c5ce")
    
    colors <- data.frame(blues, reds, greens, yellows, grays)
    
    home.checkbox <- ("mean" %in% input$homecheck)
    
    p <- plot_ly() %>% config(displayModeBar = F) %>%
      layout(legend = list(x = .5, y = 100, orientation = "h"))
    
    for(i in 1:length(these.vars.avgs)) {
      if(home.checkbox == T) { # Add overall variable mean line
        p <- add_trace(p,
                       x = dates,
                       y = these.vars.avgs[[i]],
                       type = "scatter",
                       mode = "lines",
                       opacity = 1,
                       line = list(dash = "dot", color = colors[1,i]),
                       name = paste("Average", vars[i], sep = " "),
                       text= paste("Average", vars[i], sep = " "))
      }
      if(length(selected.fips) != 0) { # Add county variable mean line
        for(j in 1:length(selected.fips)) {
          if("rescale" %in% input$homecheck) {
          p <- add_trace(p,
                         x = dates,
                         y = rescale(as.numeric(county.avgs[selected.fips[j],names(these.vars.avgs[[i]])])),
                         type = "scatter",
                         mode = "lines",
                         opacity = .5,
                         line = list(color = colors[j+1,i]),
                         name = paste(county.avgs$Name[selected.fips[j]], "County", vars[i], sep = " "),
                         text= paste(county.avgs$Name[selected.fips[j]], "County", vars[i], sep = " "))
          } else {
            p <- add_trace(p,
                           x = dates,
                           y = as.numeric(county.avgs[selected.fips[j],names(these.vars.avgs[[i]])]),
                           type = "scatter",
                           mode = "lines",
                           opacity = .5,
                           line = list(color = colors[j+1, i]),
                           name = paste(county.avgs$Name[selected.fips[j]], "County", vars[i], sep = " "),
                           text= paste(county.avgs$Name[selected.fips[j]], "County", vars[i], sep = " "))
          }
        }}
    }
    p
  })
  

  ##### HOME END #####

  ##### COVID START #####
  
  all.fips <- reactiveValues(fips = c())
  all.sensors <- reactiveValues(sensors = c())
  
  ##### REACTIVE FUNCTIONS START #####
  left.sensor <- function(map) {
    in.date <- input$covid_dt + days(6) # week shifts forward for sensor data
    if (input$covid_map_left_sensor == "pm25") {
      col <- pm25[, which(colnames(pm25) == format(in.date, "PM25_%Y%m%d"))]
      addCircles(map,
                 data = col,
                 lng = pm25$longitude,
                 lat = pm25$latitude,
                 color = pm25palette(col),
                 fillOpacity = 0.7,
                 radius = 500,
                 stroke = T,
                 layerId = pm25$Site.ID,
                 label = getLabels(in.date, pm25, "PM25"),
                 labelOptions = labelOptions(
                   style = list("font-weight" = "normal",
                                padding = "3px 8px"),
                   textsize = "15px",
                   direction = "auto"))
    }
    else if (input$covid_map_left_sensor == "aqi") {
      col <- aqi[, which(colnames(aqi) == format(in.date, "AQI_%Y%m%d"))]
      addCircles(map,
                 data = col,
                 lng = aqi$longitude,
                 lat = aqi$latitude,
                 color = aqipalette(col),
                 fillOpacity = 0.7,
                 radius = 500,
                 stroke = T,
                 layerId = aqi$Site.ID,
                 label = getLabels(in.date, aqi, "AQI"),
                 labelOptions = labelOptions(
                   style = list("font-weight" = "normal",
                                padding = "3px 8px"),
                   textsize = "15px",
                   direction = "auto"))
    }
    else if (input$covid_map_left_sensor == "pe") {
      # consider raster here? incompatible with choropleth
      addCircleMarkers(map,
                       data = cdph.permits,
                       color = "black",
                       radius = 500,
                       stroke = T,
                       opacity = 1,
                       weight = 0.75,
                       label = cdph.permits$APPLICAT_1,
                       popup = paste(paste("Applicant:", cdph.permits$APPLICAT_1, sep = " "),
                                     paste("Address:", cdph.permits$ADDRE, sep = " "),
                                     paste("Comments:", cdph.permits$COMME, sep = " "),
                                     sep = "<br>"))
    }
    else if (input$covid_map_left_sensor == "none") {
      map
    }
  }
  left.choropleth <- function(map) {
    if (input$covid_map_left_choropleth == "asthma018") {
      addPolygons(map,
                  data = asthma,
                  fillColor = asthmapalette(asthma$rate0_18),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = asthma$zip,
                  label = labels_covid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto"))
    }
    else if (input$covid_map_left_choropleth == "asthma65") {
      addPolygons(map,
                  data = asthma,
                  fillColor = asthmapalette(asthma$rate65),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = asthma$zip,
                  label = labels_covid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto"))
    }
    else if (input$covid_map_left_choropleth == "covid") {
      addPolygons(map,
                  data = covid,
                  fillColor = covidpalette(covid[, which(colnames(covid) == format(input$covid_dt, "COVID_Week_%Y%m%d"))][[1]]),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = covid$zip,
                  label = labels_covid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto"))
    }
    else if (input$covid_map_left_choropleth == "pm25") {
      addPolygons(map,
                  data = trees,
                  fillColor = pm25palette(trees$nn_q3_pm2_),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = trees$geoid,
                  label = trees$geoid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")
      )
    }
    else if (input$covid_map_left_choropleth == "svi") {
      addPolygons(map,
                  data = trees,
                  fillColor = svipalette(trees$svi_pecent),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = trees$geoid,
                  label = trees$geoid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")
      )
    }
    else if (input$covid_map_left_choropleth == "none") {
      map
    }
  }
  left.controls <- function(map) {
    map <- addControl(map,
                      paste0("From ", format(input$covid_dt, "%Y-%m-%d"), " to ", format(input$covid_dt + days(6), "%Y-%m-%d")),
                      position = "bottomright")
    # add choropleth legend
    if (input$covid_map_left_choropleth == "asthma018") {
      map <- addLegend(map, "bottomleft", pal = asthmapalette, values = asthma$rate0_18,
                       title = "Asthma ED Visits / 10,000", opacity = 1)
    }
    else if (input$covid_map_left_choropleth == "asthma65") {
      map <- addLegend(map, "bottomleft", pal = asthmapalette, values = asthma$rate65,
                       title = "Asthma ED Visits / 10,000", opacity = 1)
    }
    else if (input$covid_map_left_choropleth == "covid") {
      map <- addLegend(map, "bottomleft", pal = covidpalette, 
                       values = covid[, which(colnames(covid) == format(input$covid_dt, "COVID_Week_%Y%m%d"))][[1]],
                       title = "COVID Cases / 100,000", opacity = 1)
    }
    else if (input$covid_map_left_choropleth == "pm25") {
      map <- addLegend(map, "bottomleft", pal = pm25palette, 
                       values = trees$nn_q3_pm2_,
                       title = "PM2.5 (ug/m3)", opacity = 1)
    }
    else if (input$covid_map_left_choropleth == "svi") {
      map <- addLegend(map, "bottomleft", pal = svipalette, 
                       values = trees$svi_pecent,
                       title = "SVI Percentile", opacity = 1)
    }
    # add sensor legend
    if (input$covid_map_left_sensor == "pm25" &&
        input$covid_map_left_choropleth != "pm25") {
      map <- addLegend(map, "bottomleft", pal = pm25palette, 
                       className = "info legend legend-circles",
                       values = pm25[, which(colnames(pm25) == format(input$covid_dt + days(6), "PM25_%Y%m%d"))],
                       title = "PM2.5 (ug/m3)", opacity = 1)
    }
    else if (input$covid_map_left_sensor == "aqi") {
      map <- addLegend(map, "bottomleft", pal = aqipalette,
                       className = "info legend legend-circles",
                       values = aqi[, which(colnames(aqi) == format(input$covid_dt + days(6), "AQI_%Y%m%d"))],
                       labFormat = function(type, cuts, p) {
                         paste0(aqi.legend.labels)
                       },
                       title = "AQI", opacity = 1)
    }
    
    map
  }
  right.sensor <- function(map) {
    in.date <- input$covid_dt + days(6) # week shifts forward for sensor data
    if (input$covid_map_right_sensor == "pm25") {
      col <- pm25[, which(colnames(pm25) == format(in.date, "PM25_%Y%m%d"))]
      addCircles(map,
                 data = col,
                 lng = pm25$longitude,
                 lat = pm25$latitude,
                 color = pm25palette(col),
                 fillOpacity = 0.7,
                 radius = 500,
                 stroke = T,
                 layerId = pm25$Site.ID,
                 label = getLabels(in.date, pm25, "PM25"),
                 labelOptions = labelOptions(
                   style = list("font-weight" = "normal",
                                padding = "3px 8px"),
                   textsize = "15px",
                   direction = "auto"))
    }
    
    
    else if (input$covid_map_right_sensor == "aqi") {
      col <- aqi[, which(colnames(aqi) == format(in.date, "AQI_%Y%m%d"))]
      addCircles(map,
                 data = col,
                 lng = aqi$longitude,
                 lat = aqi$latitude,
                 color = aqipalette(col),
                 fillOpacity = 0.7,
                 radius = 500,
                 stroke = T,
                 layerId = aqi$Site.ID,
                 label = getLabels(in.date, aqi, "AQI"),
                 labelOptions = labelOptions(
                   style = list("font-weight" = "normal",
                                padding = "3px 8px"),
                   textsize = "15px",
                   direction = "auto"))
    }
    else if (input$covid_map_right_sensor == "pe") {
      # consider raster here? incompatible with choropleth
      addCircleMarkers(map,
                       data = cdph.permits,
                       color = "black",
                       radius = 0.75,
                       stroke = T,
                       opacity = 1,
                       weight = 0.75,
                       label = cdph.permits$APPLICAT_1,
                       popup = paste(paste("Applicant:", cdph.permits$APPLICAT_1, sep = " "),
                                     paste("Address:", cdph.permits$ADDRE, sep = " "),
                                     paste("Comments:", cdph.permits$COMME, sep = " "),
                                     sep = "<br>"))
    }
    else if (input$covid_map_right_sensor == "none") {
      map
    }
  }
  right.choropleth <- function(map) {
    if (input$covid_map_right_choropleth == "asthma018") {
      addPolygons(map,
                  data = asthma,
                  fillColor = asthmapalette(asthma$rate0_18),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = asthma$zip,
                  label = labels_covid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto"))
    }
    else if (input$covid_map_right_choropleth == "asthma65") {
      addPolygons(map,
                  data = asthma,
                  fillColor = asthmapalette(asthma$rate65),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = asthma$zip,
                  label = labels_covid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto"))
    }
    else if (input$covid_map_right_choropleth == "covid") {
      addPolygons(map,
                  data = covid,
                  fillColor = covidpalette(covid[, which(colnames(covid) == format(input$covid_dt, "COVID_Week_%Y%m%d"))][[1]]),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = covid$zip,
                  label = labels_covid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto"))
    }
    else if (input$covid_map_right_choropleth == "pm25") {
      addPolygons(map,
                  data = trees,
                  fillColor = pm25palette(trees$nn_q3_pm2_),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = trees$geoid,
                  label = trees$geoid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")
      )
    }
    else if (input$covid_map_right_choropleth == "svi") {
      addPolygons(map,
                  data = trees,
                  fillColor = svipalette(trees$svi_pecent),
                  fillOpacity  = 0.7,
                  color = "white",
                  stroke = FALSE,
                  weight = 2,
                  opacity = 1,
                  dashArray = "3",
                  layerId = trees$geoid,
                  label = trees$geoid,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal",
                                 padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")
      )
    }
    else if (input$covid_map_right_choropleth == "none") {
      map
    }
  }
  right.controls <- function(map) {
    map <- addControl(map,
                      paste0("From ", format(input$covid_dt, "%Y-%m-%d"), " to ", format(input$covid_dt + days(6), "%Y-%m-%d")),
                      position = "bottomright")
    # add choropleth legend
    if (input$covid_map_right_choropleth == "asthma018") {
      map <- addLegend(map, "bottomleft", pal = asthmapalette, values = asthma$rate0_18,
                       title = "Asthma ED Visits / 10,000", opacity = 1)
    }
    else if (input$covid_map_right_choropleth == "asthma65") {
      map <- addLegend(map, "bottomleft", pal = asthmapalette, values = asthma$rate65,
                       title = "Asthma ED Visits / 10,000", opacity = 1)
    }
    else if (input$covid_map_right_choropleth == "covid") {
      map <- addLegend(map, "bottomleft", pal = covidpalette, 
                       values = covid[, which(colnames(covid) == format(input$covid_dt, "COVID_Week_%Y%m%d"))][[1]],
                       title = "COVID Cases / 100,000", opacity = 1)
    }
    else if (input$covid_map_right_choropleth == "pm25") {
      map <- addLegend(map, "bottomleft", pal = pm25palette, 
                       values = trees$nn_q3_pm2_,
                       title = "PM2.5 (ug/m3)", opacity = 1)
    }
    else if (input$covid_map_right_choropleth == "svi") {
      map <- addLegend(map, "bottomleft", pal = svipalette, 
                       values = trees$svi_pecent,
                       title = "SVI Percentile", opacity = 1)
    }
    # add sensor legend
    if (input$covid_map_right_sensor == "pm25" &&
        input$covid_map_right_choropleth != "pm25") {
      map <- addLegend(map, "bottomleft", pal = pm25palette,
                       className = "info legend legend-circles",
                       values = pm25[, which(colnames(pm25) == format(input$covid_dt + days(6), "PM25_%Y%m%d"))],
                       title = "PM2.5 (ug/m3)", opacity = 1)
    }
    else if (input$covid_map_right_sensor == "aqi") {
      map <- addLegend(map, "bottomleft", pal = aqipalette, 
                       className = "info legend legend-circles",
                       values = aqi[, which(colnames(aqi) == format(input$covid_dt + days(6), "AQI_%Y%m%d"))],
                       labFormat = function(type, cuts, p) {
                         paste0(aqi.legend.labels)
                       },
                       title = "AQI", opacity = 1)
    }
    
    map
  }

  
  output$covid_map_left <- renderLeaflet({
    leaflet() %>%
      addProviderTiles("CartoDB.Positron")%>%
      list()%>% # these 3 lines fit the map to the bbox of chi.admin.map
      c(chi.bounds)%>%
      { exec(fitBounds, !!!.) }%>%
      addPolygons(data = large.area, 
                  color = "darkslategray",
                  fillOpacity  = 0.00, 
                  stroke = TRUE,
                  opacity = 1,
                  layerId = large.area$FIPS,
                  weight = 1,
                  highlight = highlightOptions(
                    weight = 2, 
                    color = "gray", 
                    fillOpacity = 0.05))%>%
      addPolygons(data = chi.boundary, 
                  color = "darkslategray",
                  fillOpacity  = 0.00, 
                  stroke = TRUE,
                  opacity = 1,
                  layerId = "Chicago",
                  weight = 2,
                  highlight = highlightOptions(
                    weight = 2, 
                    color = "gray", 
                    fillOpacity = 0.05))%>%
      left.choropleth%>%
      left.sensor%>%
      left.controls
    
  })
  output$covid_map_right <- renderLeaflet({
    leaflet() %>%
      addProviderTiles("CartoDB.Positron")%>%
      list()%>% # these 3 lines fit the map to the bbox of large.area
      c(chi.bounds)%>%
      { exec(fitBounds, !!!.) }%>%
      addPolygons(data = large.area, 
                  color = "darkslategray",
                  fillOpacity  = 0.00, 
                  stroke = TRUE,
                  opacity = 1,
                  layerId = large.area$FIPS,
                  weight = 1,
                  highlight = highlightOptions(
                    weight = 2, 
                    color = "gray", 
                    fillOpacity = 0.05))%>%
      addPolygons(data = chi.boundary, 
                  color = "darkslategray",
                  fillOpacity  = 0.00, 
                  stroke = TRUE,
                  opacity = 1,
                  layerId = "Chicago",
                  weight = 2,
                  highlight = highlightOptions(
                    weight = 2, 
                    color = "gray", 
                    fillOpacity = 0.05))%>%
      right.choropleth%>%
      right.sensor%>%
      right.controls
    
  })
  # output$covid_plot <- renderPlotly({
  #   dates <- format(strptime(rownames(covid.means), "COVID_Week_%Y%m%d"), "%Y-%m-%d")
  #   blues <- c("#033682", "#0356a3", "#0083d9", "#66ccff", "#c9e8ff")
  #   reds <- c("#9c1500", "#f52302", "#ff6e57", "#ff9a8a", "#ffc8bf")
  #   greens <- c("#165422", "#0b9926", "#14ff41", "#91faa5", "#d6ffde")
  #   
  #   p <- plot_ly() %>% config(displayModeBar = F) %>%
  #     layout(legend = list(x = .5, y = 100, orientation = "h"),
  #            shapes = list(list(type = "line", y0 = 0, y1 = 1, xref = "x", yref = "paper",
  #                               x0 = which(dates == format(input$covid_dt, "%Y-%m-%d")) - 1,
  #                               x1 = which(dates == format(input$covid_dt, "%Y-%m-%d")) - 1,
  #                               line = list(color = "darkgrey", dash = "dash"))))%>%
  #     add_trace(x = dates,
  #               y = covid.trace,
  #               type = "scatter",
  #               mode = "lines",
  #               opacity = 1,
  #               line = list(dash = "solid", color = blues[1]),
  #               name = paste("Average", "COVID cases / zip code", sep = " "),
  #               text = paste("Average", "COVID cases / zip code", sep = " ")) %>%
  #     add_trace(x = dates,
  #               y = aqi.trace,
  #               type = "scatter",
  #               mode = "lines",
  #               opacity = 1,
  #               line = list(dash = "solid", color = greens[1]),
  #               name = paste("Average", "AQI / sensor", sep = " "),
  #               text = paste("Average", "AQI / sensor", sep = " ")) %>%
  #     add_trace(x = dates,
  #               y = pm25.trace,
  #               type = "scatter",
  #               mode = "lines",
  #               opacity = 1,
  #               line = list(dash = "solid", color = reds[1]),
  #               name = paste("Average", "PM2.5 / sensor", "(ug/m3)", sep = " "),
  #               text = paste("Average", "PM2.5 / sensor", "(ug/m3)", sep = " "))
  #   
  #   if (length(all.fips$fips) > 0) {
  #     for (i in 1:length(all.fips$fips)) {
  #       p <- p %>%
  #         add_trace(x = dates,
  #                   y = as.numeric(covid.raw[which(grepl(all.fips$fips[i], covid.raw$zip)), ncol(covid.raw):(3)]),
  #                   type = "scatter",
  #                   mode = "lines",
  #                   opacity = 0.8,
  #                   line = list(dash = "dot", color = blues[(i %% length(blues)) + 1]),
  #                   name = paste("COVID cases in", all.fips$fips[i], sep = " "),
  #                   text = paste("COVID cases in", all.fips$fips[i], sep = " "))
  #     }
  #   }
  #   if (length(all.sensors$sensors) > 0) {
  #     for (i in 1:length(all.sensors$sensors)) {
  #       p <- p %>%
  #         add_trace(x = dates,
  #                   # +6 offsets week.idx to match full data frame
  #                   y = as.numeric(aqi[which(grepl(all.sensors$sensors[i], aqi$Site.ID)), (week.idx + 6)]),
  #                   type = "scatter",
  #                   mode = "lines",
  #                   opacity = 0.8,
  #                   line = list(dash = "dot", color = greens[(i %% length(greens)) + 1]),
  #                   name = paste("AQI at", 
  #                                aqi$name[which(grepl(all.sensors$sensors[i], aqi$Site.ID))], 
  #                                "sensor", sep = " "),
  #                   text = paste("AQI at", 
  #                                aqi$name[which(grepl(all.sensors$sensors[i], aqi$Site.ID))], 
  #                                "sensor", sep = " "))
  #       p <- p %>%
  #         add_trace(x = dates,
  #                   # +6 offsets week.idx to match full data frame
  #                   y = as.numeric(pm25[which(grepl(all.sensors$sensors[i], pm25$Site.ID)), (week.idx + 6)]),
  #                   type = "scatter",
  #                   mode = "lines",
  #                   opacity = 0.8,
  #                   line = list(dash = "dot", color = reds[(i %% length(reds)) + 1]),
  #                   name = paste("PM2.5 at", 
  #                                pm25$name[which(grepl(all.sensors$sensors[i], pm25$Site.ID))], 
  #                                "sensor", "(ug/m3)", sep = " "),
  #                   text = paste("PM2.5 at", 
  #                                pm25$name[which(grepl(all.sensors$sensors[i], pm25$Site.ID))], 
  #                                "sensor", "(ug/m3)", sep = " "))
  #     }
  #   }
  #   
  #   p
  # })
  # 
  # observeEvent(input$covid_map_left_shape_click, { # update reactive values on click
  #   if(input$sidebar == "covid") {
  #     if(typeof(input$covid_map_left_shape_click$id) == "character" &&
  #        str_length(input$covid_map_left_shape_click$id) == 5) { # zip code
  #       all.fips$fips <- unique(c(all.fips$fips, input$covid_map_left_shape_click$id))
  #     }
  #     else if(typeof(input$covid_map_left_shape_click$id) == "integer") { # sensor id
  #       all.sensors$sensors <- unique(c(all.sensors$sensors, input$covid_map_left_shape_click$id))
  #     }
  #   }
  # })
  # observeEvent(input$covid_map_right_shape_click, { # update reactive values on click
  #   if(input$sidebar == "covid") {
  #     if(typeof(input$covid_map_right_shape_click$id) == "character" &&
  #        str_length(input$covid_map_right_shape_click$id) == 5) { # zip code
  #       all.fips$fips <- unique(c(all.fips$fips, input$covid_map_right_shape_click$id))
  #     }
  #     else if(typeof(input$covid_map_right_shape_click$id) == "integer") { # sensor id
  #       all.sensors$sensors <- unique(c(all.sensors$sensors, input$covid_map_right_shape_click$id))
  #     }
  #   }
  # })
  
  ##### COVID END #####
  
  ##### NN START #####
  
  output$nn_map <- renderLeaflet({
    this.nn.name <- "NN_7_16"
    
    in.pal <- "ovr"
    
    nn.pal <- palFromLayer(this.nn.name, style = in.pal, raster = nn.raster)
    
    dashMap(this.nn.name, nn.pal, raster = nn.raster, area = large.area, 
            layerId = large.area$FIPS, units = "Predicted PM2.5 (ug/m3)")
  })
  
  observe({
    if (input$sidebar == "nn") { #Optimize Dashboard speed by not observing outside of tab
      in.date <- input$nn_dt
      
      this.nn.name <- getLayerName(in.date, "NN", period = "mon")
      
      ## Stopgap missing model fixes extended
      if(this.nn.name == "NN_2_15") {
        this.nn.name <- "NN_3_15"
      }
      if(this.nn.name == "NN_1_16" || this.nn.name == "NN_2_16") {
        this.nn.name <- "NN_3_16"
      }
      if(this.nn.name == "NN_1_17") {
        this.nn.name <- "NN_2_17"
      }
      
      in.pal <- input$nn_rad
       
      nn.pal <- palFromLayer(this.nn.name, style = in.pal, raster = nn.raster)
       
      sliderProxy("nn_map", this.nn.name, nn.pal, raster = nn.raster, units = "Predicted PM2.5 (ug/m3)")
    }
  })
  
  observeEvent(input$nn_map_shape_click, {
    if(input$sidebar == "nn") { #Optimize Dashboard speed by not observing outside of tab
      if(input$nn_chi_zoom == "lac") {
        
        click <- input$nn_map_shape_click
        
        zoomMap("nn_map", click, large.area)
      }
      else if (input$nn_chi_zoom == "chi") {
        click <- input$nn_map_shape_click
        
        zoomChiMap("nn_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$nn_chi_zoom, {
    if(input$sidebar == "nn") {
      if(input$nn_chi_zoom == "chi") {
        chiView("nn_map", chi.map) 
      }
      else if (input$nn_chi_zoom == "lac") {
        lacView("nn_map", large.area)
      }
    }
  })
  
  ##### NN END #####
  

  output$aod_map <- renderLeaflet({

      this.aod.name <- "AOD_3_16"

      in.pal <- "ovr"

      aod.pal <- palFromLayer(this.aod.name, style = in.pal, raster = master.raster)

      dashMap(this.aod.name, aod.pal, raster = master.raster, area = large.area,
              layerId = large.area$FIPS)

  })

  observe({
    if (input$sidebar == "aod") { #Optimize Dashboard speed by not observing outside of tab
    in.date <- input$aod_dt
    this.aod.name <- getLayerName(in.date, "AOD")

    in.pal <- input$aod_rad

    aod.pal <- palFromLayer(this.aod.name, style = in.pal, raster = master.raster)

    sliderProxy("aod_map", this.aod.name, aod.pal, raster = master.raster)
    }
  })
  
  observeEvent(input$aod_map_shape_click, {
    if(input$sidebar == "aod") { #Optimize Dashboard speed by not observing outside of tab
      if(input$aod_chi_zoom == "lac") {
        
        click <- input$aod_map_shape_click
        
        zoomMap("aod_map", click, large.area)
      }
      else if (input$aod_chi_zoom == "chi") {
        click <- input$aod_map_shape_click
        
        zoomChiMap("aod_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$aod_chi_zoom, {
    if(input$sidebar == "aod") {
      if(input$aod_chi_zoom == "chi") {
        chiView("aod_map", chi.map) 
      }
      else if (input$aod_chi_zoom == "lac") {
        lacView("aod_map", large.area)
      }
    }
  })

  output$ndvi_map <- renderLeaflet({
    this.ndvi.name <- "NDVI_3_16"
    in.pal <- "ovr"

    ndvi.pal <- palFromLayer(this.ndvi.name, style = in.pal, colors = c("lightblue", "yellow", "lightgreen", "green", "darkgreen"),
                             raster = master.raster)

    dashMap(this.ndvi.name, ndvi.pal, raster = master.raster, area = large.area, 
            layerId = large.area$FIPS)

  })

  observe({
    if (input$sidebar == "ndvi") {
    in.date <- input$ndvi_dt
    this.ndvi.name <- getLayerName(in.date, "NDVI")

    in.pal <- input$ndvi_rad

    ndvi.pal <- palFromLayer(this.ndvi.name, style = in.pal, colors = c("lightblue", "yellow", "lightgreen", "green", "darkgreen"),
                             raster = master.raster)

    sliderProxy("ndvi_map", this.ndvi.name, ndvi.pal, raster = master.raster)
    }
  })
  
  observeEvent(input$ndvi_map_shape_click, {
    if(input$sidebar == "ndvi") { #Optimize Dashboard speed by not observing outside of tab
      if(input$ndvi_chi_zoom == "lac") {
        
        click <- input$ndvi_map_shape_click
        
        zoomMap("ndvi_map", click, large.area)
      }
      else if (input$ndvi_chi_zoom == "chi") {
        click <- input$ndvi_map_shape_click
        
        zoomChiMap("ndvi_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$ndvi_chi_zoom, {
    if(input$sidebar == "ndvi") {
      if(input$ndvi_chi_zoom == "chi") {
        chiView("ndvi_map", chi.map) 
      }
      else if (input$ndvi_chi_zoom == "lac") {
        lacView("ndvi_map", large.area)
      }
    }
  })

  output$brf_map <- renderLeaflet({

    this.brf.name <- "BRDF_3_16"

    in.pal <- "ovr"

    brf.pal <- palFromLayer(this.brf.name, style = in.pal, colors = c("black", "white"), raster = master.raster)

    brf.map <- dashMap(this.brf.name, brf.pal, raster = master.raster, area = large.area, layerId = large.area$FIPS)

  })

  observe({
    if (input$sidebar == "brf") {
      in.date <- input$brf_dt
      this.brf.name <- getLayerName(in.date, "BRDF")
      
      in.pal <- input$brf_rad
      
      brf.pal <- palFromLayer(this.brf.name, style = in.pal, colors = c("black", "white"), raster = master.raster)
      
      sliderProxy("brf_map", this.brf.name, brf.pal, raster = master.raster)
    }
  })
  
  observeEvent(input$brf_map_shape_click, {
    if(input$sidebar == "brf") { #Optimize Dashboard speed by not observing outside of tab
      if(input$brf_chi_zoom == "lac") {
        
        click <- input$brf_map_shape_click
        
        zoomMap("brf_map", click, large.area)
      }
      else if (input$brf_chi_zoom == "chi") {
        click <- input$brf_map_shape_click
        
        zoomChiMap("brf_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$brf_chi_zoom, {
    if(input$sidebar == "brf") {
      if(input$brf_chi_zoom == "chi") {
        chiView("brf_map", chi.map) 
      }
      else if (input$brf_chi_zoom == "lac") {
        lacView("brf_map", large.area)
      }
    }
  })

  output$lc_map <- renderLeaflet({
    
    grn.pal <- palFromLayer("grn_ndx", colors = c("white","lightgreen", "green", "darkgreen"), raster = master.raster)
   
    lc.map <- dashMap("grn_ndx", grn.pal, raster = master.raster, area = large.area, layerId = large.area$FIPS,  rasterOpacity = 0.4)
  })
  
  observeEvent(input$lc_choose, {
    if(input$sidebar == "landcover") {
      grn.pal <- palFromLayer("grn_ndx", colors = c("white","lightgreen", "green", "darkgreen"), raster = master.raster)
      gry.pal <- palFromLayer("gry_ndx", colors = c("white", "lightgray", "gray", "darkgray", "black"), raster = master.raster)
      blu.pal <- palFromLayer("blu_ndx", colors = c("white","lightblue", "blue", "darkblue"), raster = master.raster)
      
      lc.proxy <- leafletProxy("lc_map")
      
      if(input$lc_choose == "grn_ndx") {
        lc.proxy <- lc.proxy %>%
          clearImages() %>%
          clearControls()
      
        lc.proxy <- lc.proxy %>%
          addRasterImage(master.raster[["grn_ndx"]], opacity = 0.4, colors = grn.pal) %>%
          leaflet::addLegend(pal = grn.pal, values = values(master.raster[["grn_ndx"]]), title = "Green Index")
        
        
    } else if(input$lc_choose == "gry_ndx") {
      lc.proxy <- lc.proxy %>%
        clearImages() %>%
        clearControls()
      
      lc.proxy <- lc.proxy %>%
        addRasterImage(master.raster[["gry_ndx"]], opacity = 0.4, colors = gry.pal) %>%
        leaflet::addLegend(pal = gry.pal, values = values(master.raster[["gry_ndx"]]), title = "Gray Index") 

    } else if (input$lc_choose == "blu_ndx") {
      lc.proxy <- lc.proxy %>%
        clearImages() %>%
        clearControls()
      
      lc.proxy <- lc.proxy %>%
        addRasterImage(master.raster[["blu_ndx"]], opacity = 0.4, colors = blu.pal) %>%
        leaflet::addLegend(pal = blu.pal, values = values(master.raster[["blu_ndx"]]), title = "Blue Index")
    }
    }
      
  })
  
  observeEvent(input$lc_map_shape_click, {
    if(input$sidebar == "landcover") { #Optimize Dashboard speed by not observing outside of tab
      if(input$lc_chi_zoom == "lac") {
        
        click <- input$lc_map_shape_click
        
        zoomMap("lc_map", click, large.area)
      }
      else if (input$lc_chi_zoom == "chi") {
        click <- input$lc_map_shape_click
        
        zoomChiMap("lc_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$lc_chi_zoom, {
    if(input$sidebar == "landcover") {
      if(input$lc_chi_zoom == "chi") {
        chiView("lc_map", chi.map) 
      }
      else if (input$lc_chi_zoom == "lac") {
        lacView("lc_map", large.area)
      }
    }
  })
      
  
  
  output$elevation_map <- renderLeaflet({

    elev.pal <- palFromLayer("Elev", raster = master.raster)

    elevation.map <- dashMap("Elev", elev.pal, raster = master.raster, area = large.area, layerId = large.area$FIPS, units = "(m)")

  })
  
  
  observeEvent(input$elevation_map_shape_click, {
    if(input$sidebar == "elevation") { #Optimize Dashboard speed by not observing outside of tab
      if(input$elevation_chi_zoom == "lac") {
        
        click <- input$elevation_map_shape_click
        
        zoomMap("elevation_map", click, large.area)
      }
      else if (input$elevation_chi_zoom == "chi") {
        click <- input$elevation_map_shape_click
        
        zoomChiMap("elevation_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$elevation_chi_zoom, {
    if(input$sidebar == "elevation") {
      if(input$elevation_chi_zoom == "chi") {
        chiView("elevation_map", chi.map) 
      }
      else if (input$elevation_chi_zoom == "lac") {
        lacView("elevation_map", large.area)
      }
    }
  })
  
###### EPA Variables START #####
  
###### PM2.5 START #####
  
  pm25_points <- reactive({
    if (input$pm25_res == "mon"){
      points = epa.monthly
    }
    else{
      points = epa.quarterly
    }
    return(points)
  })
  
  pm25_raster <- reactive({
    
    if (input$pm25_res == "mon"){
      raster = monthly.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  
  output$pm25_map <- renderLeaflet({
    
    this.pm25.name <- "PM25_7_16"

    in.pal <- "mon"
    
    points = epa.monthly[[this.pm25.name]]
    
    pt.bounds = c(min(points, na.rm=TRUE), max(points, na.rm=TRUE))

    pm25.pal <- palFromLayer(this.pm25.name, 
                             style = in.pal, 
                             raster = monthly.raster,
                             pt.bounds = pt.bounds)
    
    dashMap(this.pm25.name, pm25.pal,
            raster = monthly.raster, area = large.area,
            layerId = large.area$FIPS, EPApoints = epa.monthly,
            units = "(ug/m3)")
    
  })
  
  
  output$pm25_density <- renderPlot({
    pm25_density = density_plot(input$pm25_dt, "PM25", input$pm25_res, pm25_points(), "ug/m3")
    pm25_density
  })
  
  output$pm25_time <- renderPlot({
    time_plot(input$pm25_dt, "PM25", input$pm25_res, pm25_points(), "ug/m3")
  })

  observe({
    if (input$sidebar == "pm25") {
      
    in.date <- input$pm25_dt
    this.pm25.name <- getLayerName(in.date, "PM25", period = input$pm25_res)
    in.pal <- input$pm25_rad

    points = pm25_points()[[this.pm25.name]]
    pt.bounds = c(min(points, na.rm=TRUE), max(points, na.rm=TRUE))
  
    pm25.pal <- palFromLayer(this.pm25.name, 
                             style = in.pal, 
                             raster = pm25_raster(),
                             pt.bounds = pt.bounds)
    
    sliderProxy("pm25_map", this.pm25.name, pm25.pal, raster = pm25_raster(), units = "(ug/m3)", EPApoints = pm25_points())
    }
  })
  
  observeEvent(input$pm25_res, {
    if (input$sidebar == "pm25") P={
      slider_vals = switchTimeRes(input$pm25_res)

      updateSliderTextInput(session = getDefaultReactiveDomain(),
                        inputId = "pm25_dt", label = slider_vals[1],
                        selected = "2016/07",
                        choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "pm25_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$pm25_map_shape_click, {
    if(input$sidebar == "pm25") { #Optimize Dashboard speed by not observing outside of tab
      if(input$pm25_chi_zoom == "lac") {

        click <- input$pm25_map_shape_click

        zoomMap("pm25_map", click, large.area)
      }
      else if (input$pm25_chi_zoom == "chi") {
        click <- input$pm25_map_shape_click

        zoomChiMap("pm25_map", click, chi.map)
      }
    }
  })

  observeEvent(input$pm25_chi_zoom, {
    if(input$sidebar == "pm25") {
      if(input$pm25_chi_zoom == "chi") {
        chiView("pm25_map", chi.map)
      }
      else if (input$pm25_chi_zoom == "lac") {
        lacView("pm25_map", large.area)
      }
    }
  })
  ###### PM2.5 END #####
  
  ###### PM10 START #####
  
  pm10_points <- reactive({
    if (input$pm10_res == "mon"){
      points = epa.monthly
    }
    else{
      points = epa.quarterly
    }
    return(points)
  })
  
  pm10_raster <- reactive({
    
    if (input$pm10_res == "mon"){
      raster = monthly.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  
  
  output$pm10_map <- renderLeaflet({

    this.pm10.name <- "PM10_3_16"

    in.pal <- "ovr"

    pm10.pal <- palFromLayer(this.pm10.name, style = in.pal, raster = monthly.raster)

    dashMap(this.pm10.name, pm10.pal, raster = monthly.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = epa.monthly, 
            units = "(ug/m3)")

  })
  
  output$pm10_density <- renderPlot({
    pm10_density = density_plot(input$pm10_dt, "PM10", input$pm10_res, pm10_points(), "ug/m3")
    pm10_density
  })
  
  output$pm10_time <- renderPlot({
    time_plot(input$pm10_dt, "PM10", input$pm10_res, pm10_points(), "ug/m3")
  })

  observe({
    if (input$sidebar == "pm10") {
    in.date <- input$pm10_dt
    this.pm10.name <- getLayerName(in.date, "PM10", input$pm10_res)

    in.pal <- input$pm10_rad

    pm10.pal <- palFromLayer(this.pm10.name, style = in.pal, raster = pm10_raster())

    sliderProxy("pm10_map", this.pm10.name, pm10.pal, raster = pm10_raster(), units = "(ug/m3)", EPApoints = pm10_points())
    }
  })
  
  observeEvent(input$pm10_res, {
    if (input$sidebar == "pm10") P={
      
      slider_vals = switchTimeRes(input$pm10_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "pm10_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "pm10_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$pm10_map_shape_click, {
    if(input$sidebar == "pm10") { #Optimize Dashboard speed by not observing outside of tab
      if(input$pm10_chi_zoom == "lac") {
        
        click <- input$pm10_map_shape_click
        
        zoomMap("pm10_map", click, large.area)
      }
      else if (input$pm10_chi_zoom == "chi") {
        click <- input$pm10_map_shape_click
        
        zoomChiMap("pm10_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$pm10_chi_zoom, {
    if(input$sidebar == "pm10") {
      if(input$pm10_chi_zoom == "chi") {
        chiView("pm10_map", chi.map, EPApoints = epa.quarterly) 
      }
      else if (input$pm10_chi_zoom == "lac") {
        lacView("pm10_map", large.area, EPApoints = epa.quarterly)
      }
    }
  })
  
  ###### PM10 END #####
  
  ###### CO START #####
  
  co_points <- reactive({
    if (input$co_res == "mon"){
      points = epa.monthly
    }
    else{
      points = epa.quarterly
    }
    return(points)
  })
  
  co_raster <- reactive({
    
    if (input$co_res == "mon"){
      raster = monthly.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  

  output$co_map <- renderLeaflet({

    this.co.name <- "CO_3_16"

    in.pal <- "ovr"

    co.pal <- palFromLayer(this.co.name, style = in.pal, raster = monthly.raster)

    dashMap(this.co.name, co.pal, raster = monthly.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = epa.monthly)

  })
  
  output$co_density <- renderPlot({
    co_density = boxplot_dist(input$co_dt, "CO", input$co_res, co_points(), "ppm")
    co_density
  })
  
  output$co_time <- renderPlot({
    co_time = time_plot(input$co_dt, "CO", input$co_res, co_points(), "ppm")
    co_time
  })

  observe({
    if (input$sidebar == "co") {
      in.date <- input$co_dt
      this.co.name <- getLayerName(in.date, "CO", input$co_res)

      in.pal <- input$co_rad

      co.pal <- palFromLayer(this.co.name, style = in.pal, raster = co_raster())

      sliderProxy("co_map", this.co.name, co.pal, raster = co_raster(), units = "(ppm)", EPApoints = co_points())
    }
  })
  
  observeEvent(input$co_res, {
    if (input$sidebar == "co") P={
      
      slider_vals = switchTimeRes(input$co_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "co_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "co_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$co_map_shape_click, {
    if(input$sidebar == "co") { #Optimize Dashboard speed by not observing outside of tab
      if(input$co_chi_zoom == "lac") {
        
        click <- input$co_map_shape_click
        
        zoomMap("co_map", click, large.area)
      }
      else if (input$co_chi_zoom == "chi") {
        click <- input$co_map_shape_click
        
        zoomChiMap("co_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$co_chi_zoom, {
    if(input$sidebar == "co") {
      if(input$co_chi_zoom == "chi") {
        chiView("co_map", chi.map) 
      }
      else if (input$co_chi_zoom == "lac") {
        lacView("co_map", large.area)
      }
    }
  })

  ###### CO END #####
  
  ###### NO2 START #####
  
  no2_points <- reactive({
    if (input$no2_res == "mon"){
      points = epa.monthly
    }
    else{
      points = epa.quarterly
    }
    return(points)
  })
  
  no2_raster <- reactive({
    
    if (input$no2_res == "mon"){
      raster = monthly.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  
  output$no2_map <- renderLeaflet({

    this.no2.name <- "NO2_3_16"

    in.pal <- "ovr"

    no2.pal <- palFromLayer(this.no2.name, style = in.pal, raster = master.raster)

    dashMap(this.no2.name, no2.pal, raster = master.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = epa.quarterly)

  })
  
  output$no2_density <- renderPlot({
    no2_density = density_plot(input$no2_dt, "NO2", input$no2_res, no2_points(), "ppb")
    no2_density
  })

  output$no2_time <- renderPlot({
    no2_time = time_plot(input$no2_dt, "NO2", input$no2_res, no2_points(), "ppb")
    no2_time
  })
  
  observe({
    if(input$sidebar == "no2") {
    in.date <- input$no2_dt
    this.no2.name <- getLayerName(in.date, "NO2", input$no2_res)

    in.pal <- input$no2_rad

    no2.pal <- palFromLayer(this.no2.name, style = in.pal, raster = no2_raster())

    sliderProxy("no2_map", this.no2.name, no2.pal, raster = no2_raster(), units = "(ppb)", EPApoints = no2_points())
    }
  })
  
  observeEvent(input$no2_res, {
    if (input$sidebar == "no2") P={
      
      slider_vals = switchTimeRes(input$no2_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "no2_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "no2_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$no2_map_shape_click, {
    if(input$sidebar == "no2") { #Optimize Dashboard speed by not observing outside of tab
      if(input$no2_chi_zoom == "lac") {
        
        click <- input$no2_map_shape_click
        
        zoomMap("no2_map", click, large.area)
      }
      else if (input$no2_chi_zoom == "chi") {
        click <- input$no2_map_shape_click
        
        zoomChiMap("no2_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$no2_chi_zoom, {
    if(input$sidebar == "no2") {
      if(input$no2_chi_zoom == "chi") {
        chiView("no2_map", chi.map) 
      }
      else if (input$no2_chi_zoom == "lac") {
        lacView("no2_map", large.area)
      }
    }
  })
  
  ###### NO2 END #####
  
  ###### O3 START #####

  o3_points <- reactive({
    if (input$o3_res == "mon"){
      points = epa.monthly
    }
    else{
      points = epa.quarterly
    }
    return(points)
  })
  
  o3_raster <- reactive({
    
    if (input$o3_res == "mon"){
      raster = monthly.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  
  output$o3_map <- renderLeaflet({

    this.o3.name <- "Ozone_3_16"
    in.pal <- "ovr"

    o3.pal <- palFromLayer(this.o3.name, style = in.pal, raster = master.raster)

    dashMap(this.o3.name, o3.pal, raster = master.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = epa.quarterly)

  })
  
  output$o3_density <- renderPlot({
    o3_density = density_plot(input$o3_dt, "Ozone", input$o3_res, o3_points(), "ppm")
    o3_density
  })
  
  output$o3_time <- renderPlot({
    o3_time = time_plot(input$o3_dt, "Ozone", input$o3_res, o3_points(), "ppm")
    o3_time
  })

  observe({
    if (input$sidebar == "o3") {
    in.date <- input$o3_dt
    this.o3.name <- getLayerName(in.date, "Ozone", input$o3_res)

    in.pal <- input$o3_rad

    o3.pal <- palFromLayer(this.o3.name, style = in.pal, raster = o3_raster())

    sliderProxy("o3_map", this.o3.name, o3.pal, raster = o3_raster(), units = "(ppm)", EPApoints = o3_points())
    }
  })
  
  observeEvent(input$o3_res, {
    if (input$sidebar == "o3") P={
      
      slider_vals = switchTimeRes(input$o3_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "o3_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "o3_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$o3_map_shape_click, {
    if(input$sidebar == "o3") { #Optimize Dashboard speed by not observing outside of tab
      if(input$o3_chi_zoom == "lac") {
        
        click <- input$o3_map_shape_click
        
        zoomMap("o3_map", click, large.area)
      }
      else if (input$o3_chi_zoom == "chi") {
        click <- input$o3_map_shape_click
        
        zoomChiMap("o3_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$o3_chi_zoom, {
    if(input$sidebar == "o3") {
      if(input$o3_chi_zoom == "chi") {
        chiView("o3_map", chi.map) 
      }
      else if (input$o3_chi_zoom == "lac") {
        lacView("o3_map", large.area)
      }
    }
  })
  
  ###### O3 END #####
  
  ###### SO2 START #####
  
  so2_points <- reactive({
    if (input$so2_res == "mon"){
      points = epa.monthly
    }
    else{
      points = epa.quarterly
    }
    return(points)
  })
  
  so2_raster <- reactive({
    
    if (input$so2_res == "mon"){
      raster = monthly.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 

  output$so2_map <- renderLeaflet({

    this.so2.name <- "SO2_3_16"

    in.pal <- "ovr"

    so2.pal <- palFromLayer(this.so2.name, style = in.pal, raster = master.raster)

    dashMap(this.so2.name, so2.pal, raster = master.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = epa.quarterly)

  })
  
  output$so2_density <- renderPlot({
    so2_density = density_plot(input$so2_dt, "SO2", input$so2_res, so2_points(), "ppb")
    so2_density
  })
  
  output$so2_time <- renderPlot({
    so2_time = time_plot(input$so2_dt, "SO2", input$so2_res, so2_points(), "ppb")
    so2_time
  })

  observe({
    if(input$sidebar == "so2") {
      in.date <- input$so2_dt
      this.so2.name <- getLayerName(in.date, "SO2", input$so2_res)

      in.pal <- input$so2_rad

      so2.pal <- palFromLayer(this.so2.name, style = in.pal, raster = so2_raster())

      sliderProxy("so2_map", this.so2.name, so2.pal, raster = so2_raster(), units = "(ppb)",EPApoints = so2_points())
    }

  })
  
  observeEvent(input$so2_res, {
    if (input$sidebar == "so2") P={
      
      slider_vals = switchTimeRes(input$so2_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "so2_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "so2_rad",
                              choices = slider_vals[[3]])
    }
  })

  observeEvent(input$so2_map_shape_click, {
    if(input$sidebar == "so2") { #Optimize Dashboard speed by not observing outside of tab
      if(input$so2_chi_zoom == "lac") {
        
        click <- input$so2_map_shape_click
        
        zoomMap("so2_map", click, large.area)
      }
      else if (input$so2_chi_zoom == "chi") {
        click <- input$so2_map_shape_click
        
        zoomChiMap("so2_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$so2_chi_zoom, {
    if(input$sidebar == "so2") {
      if(input$so2_chi_zoom == "chi") {
        chiView("so2_map", chi.map) 
      }
      else if (input$so2_chi_zoom == "lac") {
        lacView("so2_map", large.area)
      }
    }
  })
  
  ###### SO2 END #####
  
  ###### PB START #####
  
  pb_points <- reactive({
    if (input$pb_res == "mon"){
      points = epa.monthly
    }
    else{
      points = epa.quarterly
    }
    return(points)
  })
  
  pb_raster <- reactive({
  
    if (input$pb_res == "mon"){
      raster = monthly.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  
  output$pb_map <- renderLeaflet({

    this.pb.name <- "Lead_3_16"

    in.pal <- "ovr"

    pb.pal <- palFromLayer(this.pb.name, style = in.pal, raster = master.raster)

    dashMap(this.pb.name, pb.pal, raster = master.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = epa.quarterly)

  })
  
  output$pb_density <- renderPlot({
    pb_density = density_plot(input$pb_dt, "Lead", input$pb_res, pb_points(), "ug/m3")
    pb_density
  })
  
  output$pb_time <- renderPlot({
    pb_time = time_plot(input$pb_dt, "Lead", input$pb_res, pb_points(), "ug/m3")
    pb_time
  })

  observe({
    if(input$sidebar == "pb") {

      in.date <- input$pb_dt
      this.pb.name <- getLayerName(in.date, "Lead", input$pb_res)

      in.pal <- input$pb_rad

      pb.pal <- palFromLayer(this.pb.name, style = in.pal, raster = pb_raster())

      sliderProxy("pb_map", this.pb.name, pb.pal, raster = pb_raster(), units = "(ug/m3)", EPApoints = pb_points())

    }
  })
  
  observeEvent(input$pb_res, {
    if (input$sidebar == "pb") P={
      
      slider_vals = switchTimeRes(input$pb_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "pb_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "pb_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$pb_map_shape_click, {
    if(input$sidebar == "pb") { #Optimize Dashboard speed by not observing outside of tab
      if(input$pb_chi_zoom == "lac") {
        
        click <- input$pb_map_shape_click
        
        zoomMap("pb_map", click, large.area)
      }
      else if (input$pb_chi_zoom == "chi") {
        click <- input$pb_map_shape_click
        
        zoomChiMap("pb_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$pb_chi_zoom, {
    if(input$sidebar == "pb") {
      if(input$pb_chi_zoom == "chi") {
        chiView("pb_map", chi.map) 
      }
      else if (input$pb_chi_zoom == "lac") {
        lacView("pb_map", large.area)
      }
    }
  })

  ###### PB END #####
  
  ###### EPA Variables END #####  
  
  ###### Pollution Drivers START#####  

  output$pe_map <- renderLeaflet({

    pe.pal <- palFromLayer("PECount", colors = c("darkgreen", "yellow2", "darkorange", "darkred"), raster = master.raster)
    
    pe.map <- leaflet("PECount") %>%
      setView(lng = -87.660456,
              lat = 41.845027,
              zoom = 10) %>%
      addMapPane("polygons", zIndex = 410) %>%
      addMapPane("points", zIndex = 420) %>% 
      addProviderTiles("OpenStreetMap.HOT") %>%
      addPolygons(data = chi.map,
                  color = "darkslategray",
                  stroke = T,
                  opacity = 1,
                  layerId = chi.map$area_numbe,
                  weight = 1,
                  fillOpacity = 0.01) %>%
      addRasterImage(master.raster[["PECount"]], opacity = 0.4, colors = pe.pal) %>%
      leaflet::addLegend(pal = pe.pal, values = values(master.raster[["PECount"]]), title = "NEI Point Emission Sources") %>%
      addCircleMarkers(data = cdph.permits,
                       color = "black",
                       radius = 0.75,
                       stroke = T,
                       opacity = 1,
                       weight = 0.75,
                       label = cdph.permits$APPLICAT_1,
                       popup = paste(paste("Applicant:", cdph.permits$APPLICAT_1, sep = " "),
                                     paste("Address:", cdph.permits$ADDRE, sep = " "),
                                     paste("Comments:", cdph.permits$COMME, sep = " "),
                                     sep = "<br>"),
                       options = leafletOptions(pane = "points"))
    
  pe.map
   
  })
  
    
  observeEvent(input$pe_map_shape_click, {
    if(input$sidebar == "pe") { #Optimize Dashboard speed by not observing outside of tab
      if(input$pe_chi_zoom == "lac") {
        
        click <- input$pe_map_shape_click
        
        zoomMap("pe_map", click, large.area)
      }
      else if (input$pe_chi_zoom == "chi") {
        click <- input$pe_map_shape_click
        zoomChiMap("pe_map", click, chi.map)
      }
    }
  })
  
  ####### POINT EMISSIONS######
  observeEvent(input$pe_chi_zoom, {
    if(input$sidebar == "pe") {
      
      
      pe.pal <- palFromLayer("PECount", colors = c("darkgreen", "yellow2", "darkorange", "darkred"), raster = master.raster)
      
      
      if(input$pe_chi_zoom == "chi") {
      pe.proxy <- leafletProxy("pe_map") %>%
        clearImages() %>%
        clearControls() %>%
        clearShapes()
      
      pe.proxy %>%
        flyTo(lng = -87.660456,
                lat = 41.845027,
                zoom = 10) %>%
        addPolygons(data = chi.map,
                    color = "darkslategray",
                    stroke = T,
                    opacity = 1,
                    layerId = chi.map$area_numbe,
                    weight = 1,
                    fillOpacity = 0.01) %>%
        addRasterImage(master.raster[["PECount"]], opacity = 0.4, colors = pe.pal) %>%
        leaflet::addLegend(pal = pe.pal, values = values(master.raster[["PECount"]]), title = "Point Emission Sources") %>%
        addCircleMarkers(data = cdph.permits,
                         color = "black",
                         radius = 0.75,
                         stroke = T,
                         opacity = 1,
                         weight = 0.75,
                         label = cdph.permits$APPLICAT_1,
                         popup = paste(paste("Applicant:", cdph.permits$APPLICAT_1, sep = " "),
                                       paste("Address:", cdph.permits$ADDRE, sep = " "),
                                       paste("Comments:", cdph.permits$COMME, sep = " "),
                                       sep = "<br>"),
                   options = leafletOptions(pane = "points"))
      
      
      } else if (input$pe_chi_zoom == "lac") {
        
        
        pe.proxy <- leafletProxy("pe_map") %>%
          clearControls() %>%
          clearImages() %>%
          clearShapes() %>%
          clearMarkers() 
        
        pe.pal <- palFromLayer("PECount", colors = c("darkgreen", "yellow2", "darkorange", "darkred"), raster = master.raster)
        
        pe.proxy %>%
          flyTo(lat = "41.97736", lng = "-87.62255", zoom = 7) %>% 
          addRasterImage(master.raster[["PECount"]], opacity = 0.7, colors = pe.pal) %>%
          leaflet::addLegend(pal = pe.pal, values = values(master.raster[["PECount"]]), title = "NEI Point Emission Sources") %>%
          addPolygons(data = large.area, 
                      color = "darkslategray",
                      fillOpacity  = 0.01, 
                      stroke = TRUE,
                      opacity = 1,
                      layerId = large.area$FIPS,
                      weight = 1,
                      highlight = highlightOptions(
                        weight = 2, 
                        color = "gray", 
                        fillOpacity = 0.05))
          
      }
      
    }
  })
  
  

  output$roads_map <- renderLeaflet({
    roads.pal <- palFromLayer("RdDnsty", colors = c("darkgreen", "yellow2", "darkorange", "darkred"),
                              raster = master.raster)
    roads.map <- dashMap("RdDnsty", roads.pal, 
                         raster = master.raster, 
                         area = large.area, 
                         layerId = large.area$FIPS,
                         rasterOpacity = 0.5)
  })
  
  
  observeEvent(input$roads_map_shape_click, {
    if(input$sidebar == "roads") { #Optimize Dashboard speed by not observing outside of tab
      if(input$roads_chi_zoom == "lac") {
        
        click <- input$roads_map_shape_click
        
        zoomMap("roads_map", click, large.area)
      }
      else if (input$roads_chi_zoom == "chi") {
        click <- input$roads_map_shape_click
        
        zoomChiMap("roads_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$roads_chi_zoom, {
    if(input$sidebar == "roads") {
      if(input$roads_chi_zoom == "chi") {
        chiView("roads_map", chi.map) 
      }
      else if (input$roads_chi_zoom == "lac") {
        lacView("roads_map", large.area)
      }
    }
  })
  
  ###### Pollution Drivers END#####  
  
  ###### FAA START #####
  
  temp_points <- reactive({
    if (input$temp_res == "mon"){
      points = faa.monthly
    }
    else{
      points = faa.quarterly
    }
    return(points)
  })
  
  temp_raster <- reactive({
    if (input$temp_res == "mon"){
      raster = faa.mon.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  
  output$temp_map <- renderLeaflet({
    this.temp.name <- "Temp_3_16"

    in.pal <- "ovr"

    temp.pal <- palFromLayer(this.temp.name, style = in.pal, raster = master.raster)

    dashMap(this.temp.name, temp.pal, raster = master.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = faa.quarterly, units = "(\u00B0F)")
  })
  
  
  output$temp_density <- renderPlot({
    temp_density = density_plot(input$temp_dt, "Temp", input$temp_res, temp_points(), "\u00B0F")
    temp_density
  })
  
  output$temp_time <- renderPlot({
    temp_time = time_plot(input$temp_dt, "Temp", input$temp_res, temp_points(), "\u00B0F")
    temp_time
  })
  

  observe({
    if(input$sidebar == "temp") {
      in.date <- input$temp_dt
      this.temp.name <- getLayerName(in.date, "Temp", input$temp_res)

      in.pal <- input$temp_rad

      temp.pal <- palFromLayer(this.temp.name, style = in.pal, raster = temp_raster())

      sliderProxy("temp_map", this.temp.name, temp.pal, raster = temp_raster(), units = "(\u00B0F)", EPApoints = temp_points())
    }
  })
  
  observeEvent(input$temp_res, {
    if (input$sidebar == "temp") P={
      
      slider_vals = switchTimeRes(input$temp_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "temp_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "temp_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$temp_map_shape_click, {
    if(input$sidebar == "temp") { #Optimize Dashboard speed by not observing outside of tab
      if(input$temp_chi_zoom == "lac") {
        
        click <- input$temp_map_shape_click
        
        zoomMap("temp_map", click, large.area)
      }
      else if (input$temp_chi_zoom == "chi") {
        click <- input$temp_map_shape_click
        
        zoomChiMap("temp_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$temp_chi_zoom, {
    if(input$sidebar == "temp") {
      if(input$temp_chi_zoom == "chi") {
        chiView("temp_map", chi.map) 
      }
      else if (input$temp_chi_zoom == "lac") {
        lacView("temp_map", large.area)
      }
    }
  })
  
  
  pressure_points <- reactive({
    if (input$pressure_res == "mon"){
      points = faa.monthly
    }
    else{
      points = faa.quarterly
    }
    return(points)
  })
  
  pressure_raster <- reactive({
    if (input$pressure_res == "mon"){
      raster = faa.mon.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  output$pressure_map <- renderLeaflet({
    this.pressure.name <- "Pressure_3_16"
    
    in.pal <- "ovr"
    
    pressure.pal <- palFromLayer(this.pressure.name, style = in.pal, raster = master.raster)
    
    dashMap(this.pressure.name, pressure.pal, raster = master.raster, 
            area = large.area, layerId = large.area$FIPS,
            EPApoints = faa.quarterly, units = "(mbar)")
  })
  
  output$pressure_density <- renderPlot({
    pressure_density = density_plot(input$pressure_dt, "Pressure", input$pressure_res, pressure_points(), "mbar")
    pressure_density
  })
  
  output$pressure_time <- renderPlot({
    pressure_time = time_plot(input$pressure_dt, "Pressure", input$pressure_res, pressure_points(), "mbar")
    pressure_time
  })
  
  observe({
    if(input$sidebar == "pressure") {
      in.date <- input$pressure_dt
      this.pressure.name <- getLayerName(in.date, "Pressure", input$pressure_res)
      
      in.pal <- input$pressure_rad
      
      pressure.pal <- palFromLayer(this.pressure.name, style = in.pal, raster = pressure_raster())
      
      sliderProxy("pressure_map", this.pressure.name, pressure.pal, raster = pressure_raster(), units = "(mbar)", EPApoints = pressure_points())
    }
  })
  
  observeEvent(input$pressure_res, {
    if (input$sidebar == "pressure") P={
      
      slider_vals = switchTimeRes(input$pressure_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "pressure_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "pressure_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  
  observeEvent(input$pressure_map_shape_click, {
    if(input$sidebar == "pressure") { #Optimize Dashboard speed by not observing outside of tab
      if(input$pressure_chi_zoom == "lac") {
        
        click <- input$pressure_map_shape_click
        
        zoomMap("pressure_map", click, large.area)
      }
      else if (input$pressure_chi_zoom == "chi") {
        click <- input$pressure_map_shape_click
        
        zoomChiMap("pressure_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$pressure_chi_zoom, {
    if(input$sidebar == "pressure") {
      if(input$pressure_chi_zoom == "chi") {
        chiView("pressure_map", chi.map) 
      }
      else if (input$pressure_chi_zoom == "lac") {
        lacView("pressure_map", large.area)
      }
    }
  })

  ##### PRECIPITATION START #####

  precip_points <- reactive({
    if (input$precip_res == "mon"){
      points = faa.monthly
    }
    else{
      points = faa.quarterly
    }
    return(points)
  })
  
  precip_raster <- reactive({
    if (input$precip_res == "mon"){
      raster = faa.mon.raster
    }
    else{
      raster = master.raster
    }
    
    return(raster)
  }) 
  
  output$precip_map <- renderLeaflet({
  
    this.precip.name <- "Precip_3_16"
    in.pal <- "ovr"
  
    precip.pal <- palFromLayer(this.precip.name, style = in.pal, raster = master.raster)
  
    precip.map <- dashMap(this.precip.name, precip.pal, raster = master.raster, area = large.area, layerId = large.area$FIPS,
                          EPApoints = faa.quarterly, units = "(inches)")
  })
  
  output$precip_density <- renderPlot({
    precip_density = density_plot(input$precip_dt, "Precip", input$precip_res, precip_points(), "inches")
    precip_density
  })
  
  output$precip_time <- renderPlot({
    precip_time = time_plot(input$precip_dt, "Precip", input$precip_res, precip_points(), "inches")
    precip_time
  })

  observe({
    if(input$sidebar == "precip") {
      in.date <- input$precip_dt
      this.precip.name <- getLayerName(in.date, "Precip", input$precip_res)
      
      in.pal <- input$precip_rad
      
      precip.pal <- palFromLayer(this.precip.name, style = in.pal, raster = precip_raster())
      
      sliderProxy("precip_map", this.precip.name, precip.pal, raster = precip_raster(), units = "(inches)", EPApoints = precip_points())
    }
  })
  
  observeEvent(input$precip_res, {
    if (input$sidebar == "precip") P={

      slider_vals = switchTimeRes(input$precip_res)
      
      updateSliderTextInput(session = getDefaultReactiveDomain(),
                            inputId = "precip_dt", label = slider_vals[1],
                            selected = "2016/07",
                            choices = slider_vals[[2]])
      updateRadioGroupButtons(session = getDefaultReactiveDomain(),
                              inputId = "precip_rad",
                              choices = slider_vals[[3]])
    }
  })
  
  observeEvent(input$precip_map_shape_click, {
    if(input$sidebar == "precip") { #Optimize Dashboard speed by not observing outside of tab
      if(input$precip_chi_zoom == "lac") {
        
        click <- input$precip_map_shape_click
        
        zoomMap("precip_map", click, large.area)
      }
      else if (input$precip_chi_zoom == "chi") {
        click <- input$precip_map_shape_click
        
        zoomChiMap("precip_map", click, chi.map)
      }
    }
  })
  
  observeEvent(input$precip_chi_zoom, {
    if(input$sidebar == "precip") {
      if(input$precip_chi_zoom == "chi") {
        chiView("precip_map", chi.map) 
      }
      else if (input$precip_chi_zoom == "lac") {
        lacView("precip_map", large.area)
      }
    }
  })

  ##### PRECIPITATION END #####
  
  ### FORMER SVI TAB ###
  
  # output$svi_map <- renderLeaflet({
  #   leaflet() %>%
  #     addProviderTiles("OpenStreetMap.HOT")%>%
  #     list()%>% # these 3 lines fit the map to the bbox of large.area
  #     c(chi.bounds)%>%
  #     { exec(fitBounds, !!!.) }%>%
  #     addPolygons(data = large.area, 
  #                 color = "darkslategray",
  #                 fillOpacity  = 0.00, 
  #                 stroke = TRUE,
  #                 opacity = 1,
  #                 layerId = large.area$FIPS,
  #                 weight = 1,
  #                 highlight = highlightOptions(
  #                   weight = 2, 
  #                   color = "gray", 
  #                   fillOpacity = 0.05))%>%
  #     addPolygons(data = chi.boundary, 
  #                 color = "darkslategray",
  #                 fillOpacity  = 0.00, 
  #                 stroke = TRUE,
  #                 opacity = 1,
  #                 layerId = "Chicago",
  #                 weight = 2,
  #                 highlight = highlightOptions(
  #                   weight = 2, 
  #                   color = "gray", 
  #                   fillOpacity = 0.05))%>%
  #     addPolygons(data = trees,
  #                 fillColor = svipalette(trees$svi_pecent),
  #                 fillOpacity  = 0.7,
  #                 color = "white",
  #                 stroke = FALSE,
  #                 weight = 2,
  #                 opacity = 1,
  #                 dashArray = "3",
  #                 layerId = trees$geoid,
  #                 label = trees$geoid,
  #                 labelOptions = labelOptions(
  #                   style = list("font-weight" = "normal",
  #                                padding = "3px 8px"),
  #                   textsize = "15px",
  #                   direction = "auto"))%>%
  #     addLegend("bottomleft", pal = svipalette, 
  #               values = trees$svi_pecent,
  #               title = "SVI Percentile", opacity = 1)
  #   
  # })
  # 
  # output$hardind_map <- renderLeaflet({
  #   leaflet() %>%
  #     addProviderTiles("OpenStreetMap.HOT")%>%
  #     list()%>% # these 3 lines fit the map to the bbox of large.area
  #     c(chi.bounds)%>%
  #     { exec(fitBounds, !!!.) }%>%
  #     addPolygons(data = large.area, 
  #                 color = "darkslategray",
  #                 fillOpacity  = 0.00, 
  #                 stroke = TRUE,
  #                 opacity = 1,
  #                 layerId = large.area$FIPS,
  #                 weight = 1,
  #                 highlight = highlightOptions(
  #                   weight = 2, 
  #                   color = "gray", 
  #                   fillOpacity = 0.05))%>%
  #     addPolygons(data = chi.boundary, 
  #                 color = "darkslategray",
  #                 fillOpacity  = 0.00, 
  #                 stroke = TRUE,
  #                 opacity = 1,
  #                 layerId = "Chicago",
  #                 weight = 2,
  #                 highlight = highlightOptions(
  #                   weight = 2, 
  #                   color = "gray", 
  #                   fillOpacity = 0.05))%>%
  #     addPolygons(data = trees,
  #                 fillColor = hardpalette(trees$hardship),
  #                 fillOpacity  = 0.7,
  #                 color = "white",
  #                 stroke = FALSE,
  #                 weight = 2,
  #                 opacity = 1,
  #                 dashArray = "3",
  #                 layerId = trees$geoid,
  #                 label = trees$geoid,
  #                 labelOptions = labelOptions(
  #                   style = list("font-weight" = "normal",
  #                                padding = "3px 8px"),
  #                   textsize = "15px",
  #                   direction = "auto"))%>%
  #     addLegend("bottomleft", pal = hardpalette, 
  #               values = trees$hardship,
  #               title = "Economic Hardship Index", opacity = 1)
  #   
  # })
  
  ##### DOWNLOADS START #####
  
  output$monthly_data <- downloadHandler(filename = "county_averages_monthly.csv", 
                                         content = function(file){
                                           write.csv(county.avgs, file)})
  
  output$quarterly_data <- downloadHandler(filename = "county_averages_quarterly.csv", 
                                           content = function(file) {
                                             file.copy("Data/county_averages_quarterly.csv", file)
                                           })
  
  output$master_raster  <- downloadHandler(
    filename = "Master_Raster.zip",
    content = function(file) {
      a <- tempdir()
      print(a)
      writeRaster(master.raster, paste0(a, "/Master_Raster"), format="raster", overwrite=TRUE)

      zip.path <- file.path(a, "Master_Raster.zip")
      shp.files <- list.files(a,
                              "Master_Raster", 
                              full.names = T)
      zip.cmd <- paste("zip -j",
                       zip.path,
                       paste(shp.files, collapse = " "))
      
      system(zip.cmd)
      file.copy(zip.path, file)
      file.remove(zip.path, shp.files)
    }
  )
  
  output$monthly_raster <- downloadHandler(
    filename = "Monthly_Raster.zip",
    content = function(file) {
      a <- tempdir()
      print(a)
      writeRaster(stack(c(monthly.raster, faa.mon.raster)), paste0(a, "/Monthly_Raster"), format="raster", overwrite=TRUE)
      
      zip.path <- file.path(a, "Monthly_Raster.zip")
      shp.files <- list.files(a,
                              "Monthly_Raster", 
                              full.names = T)
      zip.cmd <- paste("zip -j",
                       zip.path,
                       paste(shp.files, collapse = " "))
      
      system(zip.cmd)
      file.copy(zip.path, file)
      file.remove(zip.path, shp.files)
    }
  )
  ### Source shapefile zip download code:
  ### https://stackoverflow.com/questions/41707760/download-a-shape-file-from-shiny
  
  output$large_area_counties <- downloadHandler(
    filename = "LargeAreaCounties.zip",
    content = function(file) {
      a <- tempdir()
      st_write(large.area, dsn = a, "LargeAreaCounties", driver = "ESRI Shapefile",
               update = TRUE, delete_layer = T)
      
      zip.path <- file.path(a, "large.area.zip")
      shp.files <- list.files(a,
                              "LargeAreaCounties", 
                              full.names = T)
      zip.cmd <- paste("zip -j",
                       zip.path,
                       paste(shp.files, collapse = " "))
      
      system(zip.cmd)
      file.copy(zip.path, file)
      file.remove(zip.path, shp.files)
    }
  )

  ##### DOWNLOADS END #####
  
}

shinyApp(ui, server) 
